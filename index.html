<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="./favicon.ico?v=1"/>
  <link rel="shortcut icon" href="./favicon.ico?v=1"/>
  <title>Asignaci√≥n F8 (Corte diario) - CEDIS PANAMA</title>
  <style>
    body{font-family:Arial, sans-serif; margin:0; background:#fff;}
    .topbar{
      background: linear-gradient(90deg,#0b1f3a,#133a74);
      color:#fff; padding:12px 14px; display:flex; align-items:center; gap:12px;
      box-shadow:0 2px 10px rgba(0,0,0,.2);
      position:sticky; top:0; z-index:9999; width:100%; box-sizing:border-box;
    }
    .topbar img{width:40px;height:40px;object-fit:contain;flex-shrink:0;background:transparent;}
    .topbar .title{flex:1 1 auto;min-width:200px;display:flex;flex-direction:column;line-height:1.2;}
    .topbar .title-main{font-size:16px;font-weight:700;letter-spacing:.3px;color:#fff;}
    .topbar .title-sub{font-size:12px;font-weight:400;color:#cbd5e1;margin-top:2px;}
    .topbar .top-actions{display:flex;gap:8px;align-items:center;flex:0 0 auto;}
    .topbar .theme-select{padding:6px 8px;border:1px solid rgba(255,255,255,.25);border-radius:10px;background:transparent;color:#fff;min-width:110px;}
    .topbar .theme-select option{background:#0b1f3a;color:#fff;}
    @media (max-width:720px){
      .topbar{flex-direction:column;align-items:center;text-align:center;position:static;}
      .topbar .top-actions{width:100%;justify-content:center;margin-top:8px;}
      .topbar .theme-select{width:100%;max-width:220px;}
    }
    .page{padding:18px;}
    .grid{display:grid;grid-template-columns:420px 1fr;gap:12px;align-items:start;}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#fff;}
    h1{font-size:18px;margin:0 0 8px 0;}
    h2{font-size:14px;margin:0 0 8px 0;}
    label{display:block;font-size:12px;margin-top:6px;}
    select,input{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;box-sizing:border-box;}
    button{padding:9px 12px;border:1px solid #333;border-radius:10px;background:#fff;cursor:pointer;}
    button:disabled{opacity:.5;cursor:not-allowed;}
    .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}
    .kpi .box{border:1px solid #e5e5e5;border-radius:10px;padding:10px;}
    .kpi .value{font-size:16px;font-weight:700;margin-top:6px;}
    .muted{color:#666;font-size:12px;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .tab{border:1px solid #ddd;border-radius:999px;padding:7px 10px;font-size:12px;cursor:pointer;user-select:none;background:#fff;}
    .tab.active{border-color:#333;font-weight:700;}
    table{border-collapse:collapse;width:100%;font-size:12px;}
    th,td{border:1px solid #ddd;padding:6px;vertical-align:top;}
    th{background:#f7f7f7;position:sticky;top:0;z-index:1;}
    .scroll{max-height:62vh;overflow:auto;border:1px solid #ddd;border-radius:10px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .row > *{flex:1 1 auto;}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:2px 8px;font-size:12px;}
    .right{text-align:right;}
    .center{text-align:center;}
    .danger{color:#b00020;}
    .ok{color:#0a7a2f;}
    
    /* Botones especiales */
    .btn-main { background: #0b1f3a; color: white; border: none; font-weight:700;}
    .btn-daily { background: #0a7a2f; color: white; border: none; }
    .btn-history { background: #444; color: white; border: none; }
    .btn-secondary { background: #f0f0f0; color: #333; border: 1px solid #ccc; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="topbar">
    <img src="icons/icon-512.png" alt="Logo" width="40" height="40" onerror="this.style.display='none'">
    <div class="title">
      <div class="title-main">TORRE DE CONTROL ‚Äî Motor de Asignaci√≥n de Requisiciones F8 - CEDIS PANAMA</div>
      <div class="title-sub">
        <span id="currentDateTime">Cargando fecha...</span>
        <span style="opacity:.8;margin-left:8px;"> | C1 Corte diario ¬∑ v6.0 Full</span>
      </div>
    </div>
    <div class="top-actions">
      <select id="themeMode" class="theme-select" title="Tema">
        <option value="auto">Sistema</option>
        <option value="light">Claro</option>
        <option value="dark">Oscuro</option>
      </select>
    </div>
  </div>

  <div class="page">
    <h1><span id="mainHeader">Asignaci√≥n F8 (Corte diario)</span></h1>
    <div class="muted">
      Corte: <span id="cutDate"></span> ¬∑ Lotes elegibles: vencimiento ‚â• 30 dias <span id="minVto"></span> ¬∑
      Prioridad UE: <b>CEDIS > Hospital > Policl√≠nica > ULAPS > CAPPS</b>
    </div>

    <div class="grid" style="margin-top:12px;">
      <div class="card">
        <h2>Filtros</h2>
        <label>Buscar (C√≥digo o texto de suministro)</label>
        <input id="q" placeholder="Ej: 101000201 o metformina"/>
        
        <label>Documento (Doc)</label>
        <input id="doc" class="input" placeholder="Ej: CDCH-2025-1-417" list="docList" autocomplete="off"/>
        <datalist id="docList"></datalist>

        <!-- 1. FILTRO ORIGINAL: FECHA DEL DOCUMENTO F8 -->
        <div class="row2" style="display:flex; gap:10px; margin-top:5px;">
          <div style="flex:1;">
            <label>Fecha Doc F8 (Desde)</label>
            <input id="dateFrom" class="input" type="date"/>
          </div>
          <div style="flex:1;">
            <label>Fecha Doc F8 (Hasta)</label>
            <input id="dateTo" class="input" type="date"/>
          </div>
        </div>

        <!-- 2. NUEVO FILTRO: FECHA DE EJECUCI√ìN/ASIGNACI√ìN -->
        <div class="row2" style="display:flex; gap:10px; margin-top:5px; margin-bottom:10px; padding-top:5px; border-top:1px dashed #eee;">
          <div style="flex:1;">
            <label style="color:#0a7a2f; font-weight:bold;">Fecha Proceso/Asig (Desde)</label>
            <input id="allocDateFrom" class="input" type="date"/>
          </div>
          <div style="flex:1;">
            <label style="color:#0a7a2f; font-weight:bold;">Fecha Proceso/Asig (Hasta)</label>
            <input id="allocDateTo" class="input" type="date"/>
          </div>
        </div>

        <label>Categor√≠a UE</label>
        <select id="cat"></select>
        <label>Punto de Informaci√≥n (UE)</label>
        <select id="ue"></select>
        <label>Tipo</label>
        <select id="tipo"></select>
        <label>Estado de cobertura</label>
        <select id="estado">
          <option value="ALL">Todos</option>
          <option value="COMPLETO">Completo</option>
          <option value="PARCIAL">Parcial</option>
          <option value="SIN">Sin stock</option>
        </select>
        
        <div class="row" style="margin-top:10px;">
          <button id="btnApply">Aplicar</button>
          <button id="btnReset">Reset</button>
        </div>
        
        <div class="row" style="margin-top:10px;">
          <button id="btnExportPdf" class="btn-main">üìÑ Exportar PDF (Hoja de Asignaci√≥n)</button>
        </div>
        
        <!-- NUEVO BOT√ìN: INFORME GERENCIAL -->
        <div class="row" style="margin-top:10px;">
          <button id="btnExportPdfManager" class="btn-main" style="background:#37474f;">üìä Informe Gerencial (PDF)</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="btnExportXlsx">Exportar Excel</button>
          <button id="btnExportCsv">Exportar CSV</button>
        </div>
        
        <div class="row" style="margin-top:10px;">
          <button id="btnLoadDaily" class="btn-daily">üîÑ Ver Corte Diario</button>
          <button id="btnLoadHistory" class="btn-history">üìÇ Ver Hist√≥rico</button>
          
          <button id="btnLoadLocal" class="btn-secondary">Cargar local</button>
          <input id="fileLoad" type="file" multiple accept=".json" style="display:none"/>
        </div>

        <div class="muted" style="margin-top:10px;">
          Nota: "Solicitado redondeado" es el operable. En escasez, se aplica recorte proporcional (Fair Share).
        </div>
      </div>

      <div class="card">
        <h2>KPIs (vista filtrada)</h2>
        <div class="kpi">
          <div class="box"><div class="muted">L√≠neas</div><div class="value" id="k_lines">-</div></div>
          <div class="box"><div class="muted">Solicitado (original)</div><div class="value" id="k_req">-</div></div>
          <div class="box"><div class="muted">Solicitado (redondeado)</div><div class="value" id="k_req_r">-</div></div>
          <div class="box"><div class="muted">Asignado</div><div class="value" id="k_assigned">-</div></div>
          <div class="box"><div class="muted">Fill rate (vs Original)</div><div class="value" id="k_fill">-</div></div>
          <!-- CAMBIO 1: AGREGADO KPI CLASIFICACION -->
          <div class="box"><div class="muted">Clasificaci√≥n</div><div class="value" id="k_importancia" style="font-size:12px;">-</div></div>
        </div>

        <div class="tabs" role="tablist" aria-label="Pesta√±as">
          <div class="tab active" data-tab="asignacion">Asignaci√≥n</div>
          <div class="tab" data-tab="ue_sin">UEs sin cobertura</div>
          <div class="tab" data-tab="sku_sin">SKUs cr√≠ticos sin stock</div>
          <div class="tab" data-tab="invalidos">Pedidos inv√°lidos</div>
          <div class="tab" data-tab="fill_cat">Fill rate por categor√≠a</div>
          <!-- NUEVA PESTA√ëA: FILL RATE POR UE -->
          <div class="tab" data-tab="fill_ue">Fill rate por UE</div>
        </div>

        <div id="viewTitle" style="margin-top:10px;font-weight:700;">Asignaci√≥n (l√≠neas SALMI)</div>
        <div class="muted" id="viewHint" style="margin-top:4px;">
          Hoja operativa para reemplazar el empirismo. Incluye lotes, datos hist√≥ricos y promedio.
        </div>

        <div id="view_asignacion" class="view" style="margin-top:10px;">
          <div class="scroll">
            <table id="tbl_asignacion">
              <thead>
                <tr>
                  <th>Fecha F8</th><th>Doc</th><th>Tipo</th><th>UE</th><th>Categor√≠a</th>
                  <th>C√≥digo</th><th>Suministro</th>
                  <th class="right">Solicitado</th><th class="right">Solic. red.</th>
                  
                  <th class="right">Asignado</th>
                  <!-- AQU√ç VA RESERVADO (Entre Asignado y Pendiente) -->
                  <th class="right" style="color:purple;">Reservado</th> 
                  <th class="right">Pendiente</th>
                  
                  <th class="center">Bultos (T/S/P)</th><th>Lotes usados</th>
                  <th>√öltimo despacho</th><th class="right">Qty √∫ltimo</th>
                  <th class="right">Promedio Hist.</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- PESTA√ëAS OCULTAS -->
        <div id="view_ue_sin" class="view" style="display:none;margin-top:10px;">
          <div class="scroll"><table id="tbl_ue_sin"><thead><tr><th>UE</th><th>Categor√≠a</th><th class="right">L√≠neas sin cobertura</th><th class="right">Solicitado (original)</th><th class="right">Solicitado (red.)</th><th>Pedido m√°s reciente</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div id="view_sku_sin" class="view" style="display:none;margin-top:10px;">
          <div class="scroll"><table id="tbl_sku_sin"><thead><tr><th>C√≥digo</th><th>Suministro</th><th class="right">Solicitado (original)</th><th class="right">Solicitado (red.)</th><th class="right">N¬∫ UEs</th><th>Categor√≠as afectadas</th><th>√öltimo despacho (real)</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div id="view_invalidos" class="view" style="display:none;margin-top:10px;">
          <div class="scroll"><table id="tbl_invalidos"><thead><tr><th>Fecha</th><th>UE</th><th>Categor√≠a</th><th>C√≥digo</th><th>Suministro</th><th class="right">Solicitado (original)</th><th class="right">Empaque terciario</th><th class="right">Solicitado (red.)</th><th>Motivo</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div id="view_fill_cat" class="view" style="display:none;margin-top:10px;">
          <div class="scroll"><table id="tbl_fill_cat"><thead><tr><th>Categor√≠a</th><th class="right">L√≠neas</th><th class="right">Solicitado (original)</th><th class="right">Solicitado (red.)</th><th class="right">Asignado</th><th class="right">Fill rate</th></tr></thead><tbody></tbody></table></div>
        </div>
        <!-- NUEVA VISTA: FILL RATE POR UE -->
        <div id="view_fill_ue" class="view" style="display:none;margin-top:10px;">
          <div class="scroll"><table id="tbl_fill_ue"><thead><tr><th>UE</th><th>Categor√≠a</th><th class="right">L√≠neas</th><th class="right">Solicitado</th><th class="right">Asignado</th><th class="right">Fill Rate</th></tr></thead><tbody></tbody></table></div>
        </div>

        <div class="muted" style="margin-top:10px;">
          Si la UE aparece como <span class="pill">SIN_CATEGORIA</span>, revisa <b>ue_alias.json</b>.
        </div>
      </div>
    </div>
  </div>

<script>
  // --- UTILS ---
  function uniq(arr){ return [...new Set(arr)].filter(x => x !== null && x !== undefined); }
  function parseISODate(s){ if(!s) return null; const m = String(s).match(/(\d{4})-(\d{2})-(\d{2})/); if(!m) return null; return new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00`); }
  function fmtBultosPart(n){ const x = Number(n); if(!Number.isFinite(x)) return "0"; return Math.abs(x - Math.round(x)) < 1e-9 ? String(Math.round(x)) : String(parseFloat(x.toFixed(3))); }
  function fmtBultosTriple(t,s,p){ return `${fmtBultosPart(t)}/${fmtBultosPart(s)}/${fmtBultosPart(p)}`; }
  const fmt = (n) => { if (n === null || n === undefined || isNaN(n)) return "-"; return new Intl.NumberFormat('es-PA', {maximumFractionDigits: 0}).format(n); };
  
  function tickDateTime(){
    const el = document.getElementById('currentDateTime');
    if(el) el.textContent = new Date().toLocaleString('es-PA', { weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit' });
  }

  // --- VARIABLES ---
  let DATA = [];
  let PARAMS = {};
  let UE_ALIAS = [];
  let ACTIVE_TAB = "asignacion";
  let LAST_FILTERED = [];

  function coverage(r){
    const req = Number(r.Solicitado_redondeado || 0);
    const asg = Number(r.Asignado || 0);
    if (asg <= 0) return "SIN";
    if (asg >= req && req > 0) return "COMPLETO";
    return "PARCIAL";
  }

  function populateFilters(){
    const catSel = document.getElementById('cat');
    const ueSel = document.getElementById('ue');
    const tipoSel = document.getElementById('tipo');
    const docList = document.getElementById('docList');
    const cats = ["ALL", ...uniq(DATA.map(r => r.Categoria)).sort()];
    catSel.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join("");
    const ues = ["ALL", ...uniq(DATA.map(r => r.Punto)).sort()];
    ueSel.innerHTML = ues.map(u => `<option value="${u}">${u}</option>`).join("");
    const tipos = ["ALL", ...uniq(DATA.map(r => r.Tipo)).sort()];
    tipoSel.innerHTML = tipos.map(t => `<option value="${t}">${t}</option>`).join("");
    if(docList){
      const docs = uniq(DATA.map(r => r.N_Doc)).sort();
      docList.innerHTML = docs.map(d => `<option value="${d}"></option>`).join("");
    }
  }

  function applyFilters(){
    const q = (document.getElementById('q').value || "").trim().toLowerCase();
    const cat = document.getElementById('cat').value;
    const ue = document.getElementById('ue').value;
    const tipo = document.getElementById('tipo').value;
    const estado = document.getElementById('estado').value;
    
    // FILTROS 1: FECHA F8 (Documento)
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    // FILTROS 2: FECHA ASIGNACION (Proceso)
    const allocFrom = document.getElementById('allocDateFrom').value;
    const allocTo = document.getElementById('allocDateTo').value;

    let rows = DATA;
    const docQ = (document.getElementById('doc')?.value || '').trim().toLowerCase();
    
    if (docQ) rows = rows.filter(r => String(r.N_Doc || '').toLowerCase().includes(docQ));
    
    // APLICAR FILTRO FECHA F8
    if (dateFrom) rows = rows.filter(r => String(r.Fecha || '') >= dateFrom);
    if (dateTo) rows = rows.filter(r => String(r.Fecha || '') <= dateTo);

    // APLICAR FILTRO FECHA ASIGNACION (HIST√ìRICO)
    if (allocFrom || allocTo) {
        rows = rows.filter(r => {
            // Buscamos la fecha de proceso (Backend Hist√≥rico) o fallback a la fecha normal
            let fechaAlloc = r.Fecha_Asignacion || r.FECHA_ASIGNACION || r.Fecha_Proceso || "";
            // Si es la vista diaria, puede que no tenga Fecha_Proceso a√∫n, usamos hoy impl√≠cito o nada
            // Pero si el usuario filtra por fecha de asignaci√≥n en "Diario", asumimos que busca la fecha de hoy.
            if (!fechaAlloc && r.Fecha_Asignacion) fechaAlloc = r.Fecha_Asignacion;

            if(!fechaAlloc) return true; // Si no hay fecha de proceso, lo dejamos pasar si estamos en vista simple
            
            const dStr = String(fechaAlloc).split("T")[0];
            let pass = true;
            if (allocFrom && dStr < allocFrom) pass = false;
            if (allocTo && dStr > allocTo) pass = false;
            return pass;
        });
    }

    if (q) rows = rows.filter(r => String(r.Codigo).includes(q) || String(r.Suministro || "").toLowerCase().includes(q));
    if (cat !== "ALL") rows = rows.filter(r => r.Categoria === cat);
    if (ue !== "ALL") rows = rows.filter(r => r.Punto === ue);
    if (tipo !== "ALL") rows = rows.filter(r => r.Tipo === tipo);
    if (estado !== "ALL") rows = rows.filter(r => coverage(r) === estado);
    
    LAST_FILTERED = rows;
    renderKPIs(rows);
    renderActiveTab(rows);
  }

  function renderKPIs(rows){
    const req = rows.reduce((a,r)=>a + Number(r.Solicitado||0), 0);
    const reqR = rows.reduce((a,r)=>a + Number(r.Solicitado_redondeado||0), 0);
    const asg = rows.reduce((a,r)=>a + Number(r.Asignado||0), 0);
    const fill = req > 0 ? (asg/req)*100 : 0;
    
    document.getElementById('k_lines').textContent = fmt(rows.length);
    document.getElementById('k_req').textContent = fmt(req);
    document.getElementById('k_req_r').textContent = fmt(reqR);
    document.getElementById('k_assigned').textContent = fmt(asg);
    document.getElementById('k_fill').textContent = `${fill.toFixed(1)}%`;

    // CAMBIO 2: LOGICA VISUAL PARA KPI
    const vitales = rows.filter(r => r.Importancia === "VITAL").length;
    const esenciales = rows.filter(r => r.Importancia === "ESENCIAL").length;
    
    document.getElementById('k_importancia').innerHTML = 
        `<span style="color:#d32f2f; font-weight:bold;">üíì V: ${fmt(vitales)}</span> | <span style="color:#2e7d32; font-weight:bold;">‚úÖ E: ${fmt(esenciales)}</span>`;
  }

  function showTab(tab){
    ACTIVE_TAB = tab;
    document.querySelectorAll('.tab').forEach(el => el.classList.toggle('active', el.dataset.tab === tab));
    document.querySelectorAll('.view').forEach(v => v.style.display = "none");
    document.getElementById(`view_${tab}`).style.display = "block";
    renderActiveTab(LAST_FILTERED.length ? LAST_FILTERED : DATA);
  }

  function renderAsignacion(rows){
    const tb = document.querySelector("#tbl_asignacion tbody");
    // L√çMITE AUMENTADO
    tb.innerHTML = rows.slice(0, 10000).map(r => {
      const b = fmtBultosTriple(r.Bultos_Ter||0, r.Bultos_Sec||0, r.Bultos_Prim||0);
      const lots = r.Lotes_Usados ? r.Lotes_Usados : "";
      
      const ldFecha = r.Ultimo_Despacho || "-";
      const ldQty = r.Qty_Ultimo ? fmt(r.Qty_Ultimo) : "-";
      const prom = r.Promedio_Hist ? fmt(r.Promedio_Hist) : "-";

      return `<tr>
        <td>${r.Fecha||""}</td>
        <td>${r.N_Doc||""}</td>
        <td>${r.Tipo||""}</td>
        <td>${r.Punto||""}</td>
        <td>${r.Categoria||""}</td>
        <td>${r.Codigo||""}</td>
        <td>${r.Suministro||""}</td>
        <td class="right">${fmt(r.Solicitado)}</td>
        <td class="right">${fmt(r.Solicitado_redondeado)}</td>
        <td class="right">${fmt(r.Asignado)}</td>
        <td class="right" style="color:purple; font-weight:bold;">${r.Reservado > 0 ? fmt(r.Reservado) : "-"}</td>
        <td class="right">${fmt(r.Pendiente)}</td>
        <td class="center">${b}</td>
        <td>${lots}</td>
        <td>${ldFecha}</td>
        <td class="right">${ldQty}</td>
        <td class="right" style="background:#f0f8ff;">${prom}</td>
      </tr>`;
    }).join("");
    window.__exportRows = rows;
    window.__exportName = "asignacion";
  }

  function renderUESin(rows){
    // Filtramos l√≠neas donde NO se asign√≥ nada pero S√ç se pidi√≥ (huecos totales)
    const filtered = rows.filter(r => Number(r.Asignado||0) === 0 && Number(r.Solicitado_redondeado||0) > 0);
    const map = new Map();
    
    for(const r of filtered){
      const key = `${r.Punto||""}||${r.Categoria||""}`;
      if(!map.has(key)) map.set(key, {UE:r.Punto||"", Categoria:r.Categoria||"", lineas:0, sol:0, solr:0, pendiente:0});
      const o = map.get(key);
      o.lineas += 1;
      o.sol += Number(r.Solicitado||0);
      o.solr += Number(r.Solicitado_redondeado||0);
      // Calculamos el pendiente (lo que pidieron y no recibieron)
      o.pendiente += Number(r.Pendiente||0);
    }
    
    // Ordenamos por la cantidad pendiente (los que m√°s les falta, van primero)
    const out = [...map.values()].map(o => ({
      UE:o.UE, 
      Categoria:o.Categoria, 
      Lineas_sin_cobertura:o.lineas,
      Solicitado_original:o.sol, 
      Solicitado_redondeado:o.solr,
      Total_Pendiente:o.pendiente // Nueva m√©trica
    })).sort((a,b)=> b.Total_Pendiente - a.Total_Pendiente).slice(0,20);
    
    // Ajuste visual del encabezado HTML (Hack para no tocar el HTML est√°tico)
    const thRef = document.querySelector("#tbl_ue_sin thead tr th:last-child");
    if(thRef) thRef.textContent = "Unidades Pendientes (D√©ficit)";

    const tb = document.querySelector("#tbl_ue_sin tbody");
    tb.innerHTML = out.map(r => `<tr>
      <td>${r.UE}</td>
      <td>${r.Categoria}</td>
      <td class="right" style="font-weight:bold; color:#b71c1c;">${fmt(r.Lineas_sin_cobertura)}</td>
      <td class="right">${fmt(r.Solicitado_original)}</td>
      <td class="right">${fmt(r.Solicitado_redondeado)}</td>
      <td class="right" style="background:#fff3e0; font-weight:bold;">${fmt(r.Total_Pendiente)}</td>
    </tr>`).join("");
    
    window.__exportRows = out;
    window.__exportName = "ue_sin_cobertura_top20";
  }

  function renderSKUSin(rows){
    const filtered = rows.filter(r => Number(r.Asignado||0) === 0 && Number(r.Solicitado_redondeado||0) > 0);
    const map = new Map();
    for(const r of filtered){
      const code = String(r.Codigo||"");
      const key = `${code}||${String(r.Suministro||"")}`;
      if(!map.has(key)) map.set(key, {Codigo:code, Suministro:String(r.Suministro||""), sol:0, solr:0, ues_names:new Set(), last:null});
      const o = map.get(key);
      o.sol += Number(r.Solicitado||0);
      o.solr += Number(r.Solicitado_redondeado||0);
      o.ues_names.add(String(r.Punto||"")); // Guardamos nombres espec√≠ficos
      
      const fechaRow = r.Ultimo_Despacho;
      if(fechaRow && fechaRow !== "-"){
         const d = parseISODate(fechaRow);
         if(d && (!o.last || d > o.last)) o.last = d;
      }
    }
    const out = [...map.values()].map(o => ({
      Codigo:o.Codigo,
      Suministro:o.Suministro,
      Solicitado_original:o.sol,
      Solicitado_redondeado:o.solr,
      Num_UEs:o.ues_names.size,
      UEs_Lista:[...o.ues_names].sort().join(", "), // Lista detallada
      Ultimo_despacho_real:o.last ? o.last.toISOString().slice(0,10) : ""
    })).sort((a,b)=> (b.Solicitado_redondeado - a.Solicitado_redondeado) || (b.Num_UEs - a.Num_UEs))
      .slice(0,20);
      
    // Ajuste din√°mico del encabezado HTML para que coincida
    const thRef = document.querySelector("#tbl_sku_sin thead tr th:nth-child(6)");
    if(thRef) thRef.textContent = "UEs Afectadas (Detalle)";

    const tb = document.querySelector("#tbl_sku_sin tbody");
    tb.innerHTML = out.map(r => `<tr>
      <td>${r.Codigo}</td>
      <td>${r.Suministro}</td>
      <td class="right">${fmt(r.Solicitado_original)}</td>
      <td class="right">${fmt(r.Solicitado_redondeado)}</td>
      <td class="right">${fmt(r.Num_UEs)}</td>
      <td style="font-size:9px;">${r.UEs_Lista}</td>
      <td>${r.Ultimo_despacho_real || "-"}</td>
    </tr>`).join("");
    window.__exportRows = out;
    window.__exportName = "skus_criticos_sin_stock_top20";
  }

  function renderInvalidos(rows){
    const filtered = rows.filter(r => Number(r.Solicitado||0) > 0 && Number(r.Solicitado_redondeado||0) === 0);
    const out = filtered.slice().sort((a,b)=>{
      const da = parseISODate(a.Fecha); const db = parseISODate(b.Fecha);
      return (db - da);
    }).slice(0,2000).map(r => {
      const sol = Number(r.Solicitado||0);
      const empT = r.Empaque_Ter ? Number(r.Empaque_Ter) : null;
      
      let motivo = "Solicitado redondeado = 0";
      if(empT && sol < empT) motivo = "Solicitado menor a empaque terciario";
      else if(empT && (sol % empT) !== 0) motivo = "Solicitado no es m√∫ltiplo";
      else if(!empT) motivo = "Sin empaque definido";
      
      return {
        Fecha:r.Fecha||"", UE:r.Punto||"", Categoria:r.Categoria||"", Codigo:r.Codigo||"", Suministro:r.Suministro||"",
        Solicitado_original:sol, Empaque_terciario:empT, Solicitado_redondeado:Number(r.Solicitado_redondeado||0), Motivo:motivo
      };
    });
    const tb = document.querySelector("#tbl_invalidos tbody");
    tb.innerHTML = out.map(r => `<tr>
      <td>${r.Fecha}</td><td>${r.UE}</td><td>${r.Categoria}</td><td>${r.Codigo}</td><td>${r.Suministro}</td>
      <td class="right">${fmt(r.Solicitado_original)}</td>
      <td class="right">${r.Empaque_terciario === null ? "-" : fmt(r.Empaque_terciario)}</td>
      <td class="right">${fmt(r.Solicitado_redondeado)}</td>
      <td class="${r.Motivo.includes("menor") ? "danger" : ""}">${r.Motivo}</td>
    </tr>`).join("");
    window.__exportRows = out;
    window.__exportName = "pedidos_invalidos_por_empaque";
  }

  function renderFillCat(rows){
    const map = new Map();
    for(const r of rows){
      const cat = String(r.Categoria||"");
      if(!map.has(cat)) map.set(cat, {Categoria:cat, lineas:0, sol:0, solr:0, asg:0});
      const o = map.get(cat);
      o.lineas += 1;
      o.sol += Number(r.Solicitado||0);
      o.solr += Number(r.Solicitado_redondeado||0);
      o.asg += Number(r.Asignado||0);
    }
    const out = [...map.values()].map(o => ({
      Categoria:o.Categoria, Lineas:o.lineas, Solicitado_original:o.sol, Solicitado_redondeado:o.solr, Asignado:o.asg,
      Fill_rate: o.sol > 0 ? (o.asg/o.sol) : 0 
    })).sort((a,b)=> (a.Categoria||"").localeCompare(b.Categoria||""));
    const tb = document.querySelector("#tbl_fill_cat tbody");
    tb.innerHTML = out.map(r => `<tr>
      <td>${r.Categoria}</td>
      <td class="right">${fmt(r.Lineas)}</td>
      <td class="right">${fmt(r.Solicitado_original)}</td>
      <td class="right">${fmt(r.Solicitado_redondeado)}</td>
      <td class="right">${fmt(r.Asignado)}</td>
      <td class="right">${(r.Fill_rate*100).toFixed(1)}%</td>
    </tr>`).join("");
    window.__exportRows = out;
    window.__exportName = "fill_rate_por_categoria";
  }

  // --- NUEVA FUNCI√ìN: FILL RATE POR UE ---
  function renderFillUE(rows){
    const map = new Map();
    for(const r of rows){
      const ue = String(r.Punto||"");
      if(!map.has(ue)) map.set(ue, {UE:ue, Cat:r.Categoria||"", lineas:0, sol:0, asg:0});
      const o = map.get(ue);
      o.lineas++; o.sol += Number(r.Solicitado||0); o.asg += Number(r.Asignado||0);
    }
    const out = [...map.values()].map(o => ({
      UE:o.UE, Categoria:o.Cat, Lineas:o.lineas, Solicitado:o.sol, Asignado:o.asg, 
      Fill_rate: o.sol > 0 ? (o.asg/o.sol) : 0 
    })).sort((a,b)=> a.Fill_rate - b.Fill_rate); // Ordenar de MENOR a MAYOR cumplimiento
    
    const tb = document.querySelector("#tbl_fill_ue tbody");
    tb.innerHTML = out.map(r => {
        const color = r.Fill_rate < 0.8 ? '#ffebee' : (r.Fill_rate < 0.95 ? '#fff3e0' : '#e8f5e9');
        return `<tr style="background:${color}">
          <td>${r.UE}</td><td>${r.Categoria}</td><td class="right">${fmt(r.Lineas)}</td>
          <td class="right">${fmt(r.Solicitado)}</td><td class="right">${fmt(r.Asignado)}</td>
          <td class="right" style="font-weight:bold;">${(r.Fill_rate*100).toFixed(1)}%</td>
        </tr>`;
    }).join("");
    window.__exportRows = out; window.__exportName = "fill_rate_por_ue";
  }

  function renderActiveTab(rows){
    if(ACTIVE_TAB === "asignacion") return renderAsignacion(rows);
    if(ACTIVE_TAB === "ue_sin") return renderUESin(rows);
    if(ACTIVE_TAB === "sku_sin") return renderSKUSin(rows);
    if(ACTIVE_TAB === "invalidos") return renderInvalidos(rows);
    if(ACTIVE_TAB === "fill_cat") return renderFillCat(rows);
    // NUEVA TAB
    if(ACTIVE_TAB === "fill_ue") return renderFillUE(rows);
  }

  function exportCsv(){
    const rows = window.__exportRows || [];
    const cols = Object.keys(rows[0] || {});
    if (!cols.length) return;
    const esc = (v) => {
      const s = (v === null || v === undefined) ? "" : String(v);
      if (s.includes('"') || s.includes(",") || s.includes("\n")) return '"' + s.replaceAll('"','""') + '"';
      return s;
    };
    const csv = [cols.join(",")].concat(rows.map(r => cols.map(c => esc(r[c])).join(","))).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${window.__exportName || "export"}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function _pickingRows(){ 
    return LAST_FILTERED || []; 
  }

  function getDynamicFilename(prefix) {
    const ue = document.getElementById('ue').value;
    const cat = document.getElementById('cat').value;
    const tipo = document.getElementById('tipo').value;
    
    let parts = [prefix];
    if (ue && ue !== "ALL") parts.push(ue.replace(/[^a-zA-Z0-9\-_]/g, ""));
    if (cat && cat !== "ALL") parts.push(cat.replace(/[^a-zA-Z0-9\-_]/g, ""));
    if (tipo && tipo !== "ALL") parts.push(tipo.replace(/[^a-zA-Z0-9\-_]/g, ""));
    
    if (parts.length === 1) {
        const today = new Date();
        parts.push(`${today.getDate()}_${today.getMonth()+1}`);
    }
    
    let name = parts.join("_");
    if (name.length > 50) name = name.substring(0, 50); 
    return name;
  }

  // --- EXPORTACI√ìN PDF (FINAL: L√ìGICA VINCULADA AL DOCUMENTO) ---
  function exportPdfAsignacion(){
    const rows = _pickingRows();
    if(!rows.length){ alert("No hay datos visibles para exportar."); return; }
    
    const baseName = getDynamicFilename("Hoja_Asignacion");
    const fechaGen = new Date().toLocaleString("en-US");

    const groups = new Map();
    
    // 1. RECORREMOS LAS FILAS PARA AGRUPAR POR DOCUMENTO
    for(const r of rows){
      const ue = r.Punto || "SIN_UE";
      const doc = r.N_Doc || "SIN_DOC";
      const key = ue + "||" + doc;
      const pr = Number.isFinite(+r.Prioridad) ? +r.Prioridad : 999;
      const f8  = (r.Fecha||"");
      
       // --- L√ìGICA DE FECHA (HTML LIMPIO) ---
      // Leemos el dato que ahora el servidor manda correctamente como texto ("1/16/2026")
      let fechaRaw = r.FECHA_ASIGNACION; 

      // CASO 1: CORTE DIARIO (Viene vac√≠o) -> Usamos HOY
      if (!fechaRaw || fechaRaw === "---" || fechaRaw === "") {
          const hoy = new Date();
          // Formato manual simple: M/D/YYYY
          fechaRaw = `${hoy.getMonth()+1}/${hoy.getDate()}/${hoy.getFullYear()}`;
      }
      
      // CASO 2: HIST√ìRICO (Viene dato) -> Usamos lo que mand√≥ el servidor tal cual
      // Solo hacemos una limpieza preventiva por si acaso viniera hora (T00:00...)
      else {
           fechaRaw = String(fechaRaw).split("T")[0]; 
      }
      // -----------------------------------------------------

      if(!groups.has(key)){ 
        groups.set(key, {
          ue, doc, tipo: r.Tipo||"", prioridad: pr, maxFecha: f8, 
          items: [],
          fechaAsig: fechaRaw, // Asignamos la fecha calculada al GRUPO (Documento)
          totalSol: 0, totalRed: 0, totalAsig: 0, totalPend: 0
        }); 
      }
      const g = groups.get(key);
      g.items.push(r);
      
      // Sumamos totales del documento
      g.totalSol += Number(r.Solicitado||0);
      g.totalRed += Number(r.Solicitado_redondeado||0);
      g.totalAsig += Number(r.Asignado||0);
      g.totalPend += Number(r.Pendiente||0);

      if(String(f8) > String(g.maxFecha)) g.maxFecha = f8;
      
      // Si el grupo ya existe pero ten√≠a una fecha "rara" y esta fila trae una mejor, actualizamos
      // Esto asegura que el Documento tenga la fecha correcta
      if((!g.fechaAsig || g.fechaAsig.length < 6) && fechaRaw.length > 5) {
          g.fechaAsig = fechaRaw;
      }
      
      if(pr < g.prioridad) g.prioridad = pr;
    }
    
    // 2. ORDENAMOS Y GENERAMOS HTML
    const groupsArr = Array.from(groups.values()).sort((a,b)=>{
      if(a.prioridad !== b.prioridad) return a.prioridad - b.prioridad;
      return String(a.doc).localeCompare(String(b.doc));
    });

    const esc = (s) => (s===null||s===undefined) ? "" : String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    const fmt0 = (n) => { const x = Number(n); if(!Number.isFinite(x)) return ""; return x.toLocaleString("en-US", {maximumFractionDigits: 0}); };

    // --- CAMBIO 3: ICONOS CREATIVOS Y LOGICA DE FILA ---
    const makeRow = (r) => {
      const b = fmtBultosTriple(r.Bultos_Ter||0, r.Bultos_Sec||0, r.Bultos_Prim||0);
      const lotes = r.Lotes_Usados ? String(r.Lotes_Usados) : "";
      
      let rowStyle = "";
      let icons = [];
      
      // FRIO (Copo de nieve)
      if(r.Frio) {
         rowStyle = "background-color: #e3f2fd;"; 
         icons.push("‚ùÑÔ∏è"); 
      }
      
      // IMPORTANCIA (Iconos Solicitados)
      if(r.Importancia === "VITAL") {
         rowStyle = "background-color: #ffebee;"; 
         icons.push("<span style='font-size:10px;' title='VITAL'>üíì</span>"); 
      } else if (r.Importancia === "ESENCIAL") {
         if(!r.Frio) rowStyle = "background-color: #e8f5e9;"; 
         icons.push("<span style='font-size:10px;' title='ESENCIAL'>‚úÖ</span>"); 
      }

      // Mezcla FRIO + VITAL
      if (r.Frio && r.Importancia === "VITAL") {
          rowStyle = "background-color: #e1f5fe; border-left: 4px solid #d32f2f;";
      }

      const iconHtml = icons.length ? `<div style="margin-top:1px;">${icons.join(" ")}</div>` : "";

      return `
      <tr style="${rowStyle}">
        <td>
            ${esc(r.Codigo)} 
            ${iconHtml}
        </td>
        <td>
            ${esc(r.Suministro||"")}
            ${r.Importancia ? `<div style="font-size:7px; font-weight:bold; color:#555; margin-top:2px;">[${r.Importancia}]</div>` : ""}
        </td>
        <td class="num">${fmt0(r.Solicitado)}</td>
        <td class="num">${fmt0(r.Solicitado_redondeado)}</td>
        <td class="num" style="background:rgba(255,255,255,0.5); font-weight:bold;">${fmt0(r.Asignado)}</td>
        <td class="num" style="color:purple; font-weight:bold;">${r.Reservado > 0 ? fmt0(r.Reservado) : "-"}</td>
        <td class="num">${fmt0(r.Pendiente)}</td>
        <td class="center">${esc(b)}</td>
        <td style="font-size:9px;">${esc(lotes)}</td>
        <td>${esc(r.Ultimo_Despacho || "-")}</td>
        <td class="num">${r.Qty_Ultimo ? fmt0(r.Qty_Ultimo) : ""}</td>
        <td class="num">${r.Promedio_Hist ? fmt0(r.Promedio_Hist) : ""}</td>
      </tr>`;
    };

    const sections = groupsArr.map((g, idx) => {
      g.items.sort((a,b)=> String(a.Codigo||"").localeCompare(String(b.Codigo||"")));
      const rowsHtml = g.items.map(makeRow).join("");
      const totalItems = g.items.length;
      
      const escasezDetectada = g.totalRed > g.totalAsig;
      const fillRate = g.totalSol > 0 ? ((g.totalAsig / g.totalSol) * 100).toFixed(1) + "%" : "0%";
      let escasezLabel = escasezDetectada ? "‚ö†Ô∏è S√ç (Fair Share aplicado)" : "‚úÖ NO (Stock suficiente)";
      let escasezClass = escasezDetectada ? "color:#b00020;" : "color:#0a7a2f;";

      if (g.items.some(i => i.Pack_Missing)) {
         escasezLabel += ` <span style="color:#b00020; font-size:10px; margin-left:8px;">(Nota: No existe empaque definido)</span>`;
      }

      // Mostramos la fecha del GRUPO (Documento) que calculamos arriba
      let fechaMostrar = g.fechaAsig; 

      // --- CAMBIO 4: STAMPS DE FRIO Y DIAS DE ENTREGA ---
      const tieneFrio = g.items.some(i => i.Frio);
      const stampFrio = tieneFrio 
        ? `<span style="border:1px solid #0277bd; background:#e1f5fe; color:#0277bd; padding:2px 6px; border-radius:4px; font-weight:bold; font-size:10px; margin-left:8px;">‚ùÑÔ∏è REFRIGERADO</span>` 
        : "";

      const diasEntregaRaw = g.items[0].Dias_Entrega || "";
      const stampDias = diasEntregaRaw
        ? `<div style="margin-top:4px; background:#fff; border:1px dashed #333; padding:3px 8px; font-size:11px; font-weight:bold; color:#333; display:inline-block; border-radius:4px;">üöö ENTREGA: ${esc(diasEntregaRaw)}</div>`
        : "";

      return `
        <div class="section">
          <table>
            <thead>
              <tr>
                <td colspan="11" style="background:#fff; border-bottom:2px solid #0b1f3a; padding: 10px 0;">
                  <div style="display:flex; gap:15px; align-items:center;">
                    <img src="./icons/icon-512.png" style="width:50px; height:50px; object-fit:contain;" alt="logo"/>
                    <div style="flex:1;">
                      <div style="font-size:18px; font-weight:700; color:#0b1f3a;">HOJA DE ASIGNACI√ìN F8 ‚Äî CORTE DIARIO</div>
                      <div style="font-size:11px; color:#444; margin-top:4px;">Generado: ${esc(fechaGen)}</div>
                      <div style="font-size:10px; color:#666; margin-top:2px; font-style:italic;">
                         Reglas de Asignaci√≥n: <b>Fair Share (Reparto Proporcional en Escasez)</b>, FEFO, Vto ‚â• 30 d√≠as.
                         <br>Prioridad por Tipo de Unidad Ejecutora: <b>CEDIS > HOSPITAL > POLICLINICA > ULAPS > CAPPS</b>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              <tr class="meta-row">
                <th colspan="11" style="background:#f4f6f8; color:#0b1f3a; padding:10px; border-bottom:2px solid #0b1f3a; border-top:none;">
                  <div style="display:flex; justify-content:space-between; align-items:start;"> <!-- Align start para que quepan los stamps -->
                    <div>
                        <div style="font-size:14px; font-weight:900;">${esc(g.ue)} ${stampFrio}</div>
                        ${stampDias}
                    </div>
                    <div style="font-size:11px; text-align:right;">L√≠neas: <b>${totalItems}</b></div>
                  </div>
                  <div style="margin-top:4px; font-size:11px; display:flex; gap:15px; color:#444;">
                    <span>Doc: <b>${esc(g.doc)}</b></span>
                    <span>Tipo: <b>${esc(g.tipo)}</b></span>
                    <span>Fecha F8: <b>${esc(g.maxFecha||"")}</b></span>
                    <span style="background:#fff; border:1px solid #ccc; padding:0 4px; border-radius:3px;">Fecha Asignaci√≥n: <b>${esc(fechaMostrar)}</b></span>
                  </div>
                  <div style="margin-top:6px; padding-top:6px; border-top:1px solid #ccc; font-size:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-weight:bold; ${escasezClass}">Escasez: ${escasezLabel}</div>
                    <div style="display:flex; gap:12px; background:#fff; padding:3px 8px; border-radius:4px; border:1px solid #ddd;">
                       <span>Solic.: <b>${fmt0(g.totalSol)}</b></span>
                       <span>Red.: <b>${fmt0(g.totalRed)}</b></span>
                       <span style="color:#0052cc;">Asig.: <b>${fmt0(g.totalAsig)}</b></span>
                       <span>Pend.: <b>${fmt0(g.totalPend)}</b></span>
                       <span>Fill Rate: <b>${fillRate}</b></span>
                    </div>
                  </div>
                </th>
              </tr>
              <tr class="col-header">
                <th style="width:70px;">C√≥digo</th>
                <th>Suministro</th>
                <th style="width:50px;" class="num">Solic.</th>
                <th style="width:50px;" class="num">Sol.red</th>
                <th style="width:50px;" class="num">Asig.</th>
                <th style="width:50px; color:purple;" class="num">Reserv.</th>
                <th style="width:50px;" class="num">Pend.</th>
                <th style="width:65px;" class="center">Bultos</th>
                <th style="width:130px;">Lotes</th>
                <th style="width:65px;">√ölt.desp</th>
                <th style="width:40px;" class="num">Qty</th>
                <th style="width:40px;" class="num">Prom</th>
              </tr>
            </thead>
            <tbody>${rowsHtml}</tbody>
          </table>
          
          <div class="sign">
             <div>Preparado por: __________________</div>
             <div>Recibido por: __________________</div>
             <div>Fecha: __________________</div>
          </div>
          <div style="text-align:center; font-size:9px; color:#999; margin-top:5px; border-top:1px dashed #ccc; padding-top:2px;">
             Fin del Documento ${esc(g.doc)}
          </div>
        </div>`;
    }).join("");

    const html = `<!doctype html><html lang="es"><head><meta charset="utf-8"/><title>${baseName}</title>
    <style>
      body{font-family:'Segoe UI', Arial, sans-serif; color:#111; margin:0;}
      table { width: 100%; border-collapse: collapse; margin-bottom: 0; }
      thead { display: table-header-group; } 
      tr { page-break-inside: auto; } 
      th, td { border: 1px solid #ccc; padding: 4px 5px; font-size: 10px; vertical-align: top; }
      thead tr:first-child td { border: none; }
      .col-header th { background: #f3f5f8; font-weight: bold; color: #333; text-transform: uppercase; }
      .num { text-align: right; } .center { text-align: center; }
      .section { margin-bottom: 20px; page-break-after: always; } .section:last-child { page-break-after: auto; }
      .sign { display: flex; justify-content: space-between; gap: 20px; margin-top: 30px; font-size: 11px; page-break-inside: avoid; }
      @media print { body { margin: 10mm; } }
    </style></head><body>${sections}</body></html>`;
    
    const w = window.open("", "_blank"); 
    if(w) {
        w.document.open(); w.document.write(html); w.document.close(); w.focus(); 
        setTimeout(()=>{ w.print(); }, 500);
    }
  }

  // --- INFORME GERENCIAL (PDF FINAL CON DOBLE GR√ÅFICA) ---
  function exportPdfGerencial(){
    const rows = _pickingRows();
    if(!rows.length){ alert("No hay datos para generar el informe."); return; }
    
    // 1. FECHA DE ASIGNACI√ìN REAL
    let fechaMostrar = "---";
    const fechasUnicas = [...new Set(rows.map(r => {
        let f = r.Fecha_Asignacion || r.FECHA_ASIGNACION || r.Fecha_Proceso || r.DIA_PROCESO;
        if(!f) return null;
        return String(f).split("T")[0]; 
    }).filter(f => f))].sort();

    if (fechasUnicas.length === 1) {
        const parts = fechasUnicas[0].split("-");
        if(parts.length === 3) fechaMostrar = `${parts[1]}/${parts[2]}/${parts[0]}`; 
        else fechaMostrar = fechasUnicas[0];
    } else if (fechasUnicas.length > 1) {
        fechaMostrar = `Rango: ${fechasUnicas[0]} al ${fechasUnicas[fechasUnicas.length-1]}`;
    } else {
        fechaMostrar = (PARAMS && PARAMS.cut_date) ? PARAMS.cut_date : new Date().toLocaleDateString("es-PA");
    }

    const fechaGen = new Date().toLocaleString("es-PA");
    const fileName = `Informe_Gerencial_${fechaMostrar.replace(/[^a-zA-Z0-9]/g, "-")}`;
    const fmtP = (n) => (n*100).toFixed(1) + "%";

    // 2. DATA: KPIs
    const totalRenglones = rows.length;
    const totalSol = rows.reduce((a,r)=>a+Number(r.Solicitado||0),0);
    const totalAsg = rows.reduce((a,r)=>a+Number(r.Asignado||0),0);
    const globalFill = totalSol > 0 ? (totalAsg/totalSol) : 0;
    const vitales = rows.filter(r => r.Importancia === "VITAL").length;
    const esenciales = rows.filter(r => r.Importancia === "ESENCIAL").length;

    // 3. UEs SIN COBERTURA
    const uesSinData = rows.filter(r => Number(r.Asignado||0) === 0 && Number(r.Solicitado_redondeado||0) > 0);
    const ueSinMap = new Map();
    uesSinData.forEach(r => {
        const k = r.Punto + "|" + r.Categoria;
        if(!ueSinMap.has(k)) ueSinMap.set(k, {ue:r.Punto, cat:r.Categoria, lines:0, solOrig:0, solRed:0});
        const o = ueSinMap.get(k); o.lines++; o.solOrig+=Number(r.Solicitado||0); o.solRed+=Number(r.Solicitado_redondeado||0);
    });
    const ueSinList = [...ueSinMap.values()].sort((a,b)=> b.solRed - a.solRed);

    // 4. SKUs CR√çTICOS
    const skuSinData = rows.filter(r => Number(r.Asignado||0) === 0 && Number(r.Solicitado_redondeado||0) > 0);
    const skuSinMap = new Map();
    skuSinData.forEach(r => {
        const k = r.Codigo;
        if(!skuSinMap.has(k)) skuSinMap.set(k, {code:r.Codigo, name:r.Suministro, imp:r.Importancia, sol:0, ues_names:new Set()});
        const o = skuSinMap.get(k); o.sol+=Number(r.Solicitado||0); o.ues_names.add(r.Punto);
    });
    const skuSinList = [...skuSinMap.values()].map(x=>({...x, count: x.ues_names.size, listaUEs: [...x.ues_names].sort().join(", ")})).sort((a,b)=> {
        const impOrder = { "VITAL": 3, "ESENCIAL": 2, "": 1 };
        return (impOrder[b.imp||""]||0) - (impOrder[a.imp||""]||0) || b.sol - a.sol;
    });

    // 5. FILL RATE POR UE
    const fillUeMap = new Map();
    rows.forEach(r => {
        const k = r.Punto || "SIN UE";
        if(!fillUeMap.has(k)) fillUeMap.set(k, {ue:k, cat:r.Categoria, sol:0, asg:0});
        const o = fillUeMap.get(k); o.sol+=Number(r.Solicitado||0); o.asg+=Number(r.Asignado||0);
    });
    const fillUeList = [...fillUeMap.values()].map(x=>({...x, rate: x.sol>0?x.asg/x.sol:0})).sort((a,b)=>a.rate - b.rate);

    // 6. CHART CATEGOR√çAS
    const catMap = new Map();
    rows.forEach(r => {
        const c = r.Categoria || "SIN CATEGORIA";
        if(!catMap.has(c)) catMap.set(c, {cat:c, sol:0, asg:0});
        const o = catMap.get(c); o.sol+=Number(r.Solicitado||0); o.asg+=Number(r.Asignado||0);
    });
    const catList = [...catMap.values()].map(x => ({...x, rate: x.sol>0?x.asg/x.sol:0})).sort((a,b)=>a.cat.localeCompare(b.cat));

    // --- HTML GENERATORS ---
    const colorGlobal = globalFill >= 0.9 ? "#2e7d32" : (globalFill >= 0.7 ? "#f9a825" : "#c62828");
    
    const htmlUeSin = ueSinList.map(u => `<tr><td>${u.ue}</td><td>${u.cat}</td><td class="center" style="font-weight:bold;color:#b71c1c;">${u.lines}</td><td class="right">${fmt(u.solOrig)}</td><td class="right">${fmt(u.solRed)}</td></tr>`).join("");
    
    const htmlSkuSin = skuSinList.map(s => {
        const icon = s.imp==="VITAL"?"üíì":(s.imp==="ESENCIAL"?"‚úÖ":"");
        const bg = s.imp==="VITAL"?"#ffebee":(s.imp==="ESENCIAL"?"#e8f5e9":"");
        return `<tr style="background:${bg}"><td>${s.code}</td><td>${icon} ${s.name}</td><td class="center"><span style="font-size:8px;font-weight:bold;">${s.imp||"-"}</span></td><td class="right">${fmt(s.sol)}</td><td class="center">${s.count}</td><td style="font-size:7px; color:#444;">${s.listaUEs}</td></tr>`;
    }).join("");

    const htmlFillUe = fillUeList.map(u => {
        const color = u.rate < 0.8 ? "#ffebee" : "";
        return `<tr style="background:${color}"><td>${u.ue}</td><td style="font-size:8px;">${u.cat}</td><td class="right">${fmt(u.sol)}</td><td class="right">${fmt(u.asg)}</td><td class="right"><b>${fmtP(u.rate)}</b></td></tr>`;
    }).join("");

    // Gr√°fica Categor√≠as
    const htmlChartCat = catList.map(c => {
        const w = (c.rate * 100).toFixed(0); const col = c.rate < 0.8 ? "#c62828" : (c.rate < 0.95 ? "#f9a825" : "#2e7d32");
        return `<div style="display:flex; align-items:center; margin-bottom:6px;"><div style="width:180px; font-size:9px; text-align:right; padding-right:10px;">${c.cat}</div><div style="flex:1; background:#eee; height:12px; border-radius:3px;"><div style="width:${w}%; background:${col}; height:100%; border-radius:3px; min-width:2px;"></div></div><div style="width:40px; font-size:9px; font-weight:bold; padding-left:10px;">${fmtP(c.rate)}</div></div>`;
    }).join("");

    // Gr√°fica UEs (Nueva)
    const htmlChartUE = fillUeList.map(u => {
        const w = (u.rate * 100).toFixed(0); const col = u.rate < 0.8 ? "#c62828" : (u.rate < 0.95 ? "#f9a825" : "#2e7d32");
        return `<div style="display:flex; align-items:center; margin-bottom:4px;"><div style="width:180px; font-size:8px; text-align:right; padding-right:10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${u.ue}</div><div style="flex:1; background:#eee; height:10px; border-radius:3px;"><div style="width:${w}%; background:${col}; height:100%; border-radius:3px; min-width:2px;"></div></div><div style="width:40px; font-size:8px; font-weight:bold; padding-left:10px;">${fmtP(u.rate)}</div></div>`;
    }).join("");

    const html = `
    <!doctype html><html><head><title>${fileName}</title><style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 10mm; color: #333; font-size: 10px; }
        h1 { font-size: 18px; margin: 0; color: #0b1f3a; text-transform:uppercase; } 
        h2 { font-size: 12px; margin: 20px 0 8px 0; color: #0b1f3a; border-bottom: 2px solid #ccc; padding-bottom: 3px; }
        .header { display: flex; justify-content: space-between; border-bottom: 3px solid #0b1f3a; padding-bottom: 10px; margin-bottom: 15px; }
        .kpi-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
        .kpi { border: 1px solid #ddd; padding: 8px; border-radius: 4px; text-align: center; background: #fff; }
        .kpi-n { font-size: 16px; font-weight: bold; color: #0b1f3a; }
        .kpi-l { font-size: 9px; color: #666; text-transform: uppercase; margin-top: 2px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; page-break-inside: auto; }
        tr { page-break-inside: avoid; page-break-after: auto; }
        th { background: #0b1f3a; color: white; text-align: left; padding: 5px; font-size: 9px; }
        td { border-bottom: 1px solid #eee; padding: 4px; }
        .right { text-align: right; } .center { text-align: center; }
        .page-break { page-break-before: always; }
        .chart-box { border:1px solid #ddd; padding:15px; background:#fafafa; border-radius:8px; margin-top:10px; }
    </style></head><body>
        <div class="header">
            <div>
                <h1>INFORME GERENCIAL DE ASIGNACIONES DEL ALMACEN CEDIS PANAMA</h1>
                <div style="margin-top:5px; font-size:12px;"><b>Fecha de Asignaci√≥n: ${fechaMostrar}</b></div>
                <div style="margin-top:4px; font-size:9px; color:#555; font-style:italic; line-height:1.3;">
                    Reglas de Asignaci√≥n: Fair Share (Reparto Proporcional en Escasez), FEFO, Vto ‚â• 30 d√≠as.<br>
                    Prioridad por Tipo de Unidad Ejecutora: <b>CEDIS > HOSPITAL > POLICLINICA > ULAPS > CAPPS</b>
                </div>
            </div>
            <div style="text-align:right;">Generado: ${fechaGen}<br>Torre de Control v1.0</div>
        </div>

        <div class="kpi-row">
            <div class="kpi" style="border-top:3px solid ${colorGlobal}"><div class="kpi-n" style="color:${colorGlobal}">${fmtP(globalFill)}</div><div class="kpi-l">Fill Rate Global</div></div>
            <div class="kpi"><div class="kpi-n">${fmt(totalRenglones)}</div><div class="kpi-l">Total Renglones</div></div>
            <div class="kpi"><div class="kpi-n">${fmt(totalSol)}</div><div class="kpi-l">Unidades Solicitadas</div></div>
            <div class="kpi"><div class="kpi-n">${fmt(totalAsg)}</div><div class="kpi-l">Unidades Asignadas</div></div>
            <div class="kpi"><div class="kpi-n">üíì ${vitales} | ‚úÖ ${esenciales}</div><div class="kpi-l">Renglones Vitales / Esenciales</div></div>
        </div>

        <h2>1. UNIDADES EJECUTORAS SIN COBERTURA (0% ASIGNACI√ìN)</h2>
        <div style="font-size:9px; color:#666; margin-bottom:5px;">Unidades que solicitaron producto pero no recibiran nada por escasez de inventario.</div>
        <table><thead><tr><th>Unidad Ejecutora</th><th>Categor√≠a</th><th class="center">Renglones en 0</th><th class="right">Cant. Original</th><th class="right">Ajuste Empaque</th></tr></thead><tbody>${htmlUeSin||"<tr><td colspan='5' class='center'>Excelente. No hay unidades con 0% de cobertura.</td></tr>"}</tbody></table>

        <h2>2. RENGLONES CR√çTICOS SIN STOCK (TODOS)</h2>
        <div style="font-size:9px; color:#666; margin-bottom:5px;">Medicamentos e insumos solicitados con inventario agotado.</div>
        <table><thead><tr><th style="width:10%;">C√≥digo</th><th style="width:30%;">Suministro</th><th style="width:5%;" class="center">Imp</th><th style="width:10%;" class="right">Cant. Sol.</th><th style="width:5%;" class="center"># UEs</th><th style="width:40%;">UEs Afectadas (Detalle)</th></tr></thead><tbody>${htmlSkuSin}</tbody></table>

        <div class="page-break"></div>

        <h2>3. DETALLE DE CUMPLIMIENTO POR UNIDAD EJECUTORA</h2>
        <table><thead><tr><th>Unidad Ejecutora</th><th>Categor√≠a</th><th class="right">Solicitado</th><th class="right">Asignado</th><th class="right">Fill Rate</th></tr></thead><tbody>${htmlFillUe}</tbody></table>

        <div class="page-break"></div>

        <h2>4. RESUMEN GR√ÅFICO DE FILL RATE ESPERADO POR UNIDAD EJECUTORA</h2>
        <div class="chart-box">${htmlChartUE}</div>
        
        <h2>5. RESUMEN GR√ÅFICO DE FILL RATE ESPERADO POR CATEGOR√çA DE UNIDAD EJECUTORA</h2>
        <div class="chart-box">${htmlChartCat}</div>

        <div style="text-align:center; color:#999; margin-top:20px; font-size:9px;">Fin del Informe Gerencial</div>
    </body></html>`;

    const w = window.open("", "_blank");
    if(w) { 
        w.document.open(); 
        w.document.write(html); 
        w.document.close(); 
        w.document.title = fileName; 
        setTimeout(()=>{ w.print(); }, 500); 
    }
  }

  function exportXlsxAsignacion(){
    const rows = _pickingRows(); 
    if(!rows.length){ alert("No hay datos visibles para exportar."); return; }
    if(typeof XLSX === "undefined"){ alert("No se pudo cargar XLSX."); return; }
    
    const fileName = getDynamicFilename("Asignacion_F8") + ".xlsx";

    const groups = new Map();
    for(const r of rows){
      const ue = r.Punto || "SIN_UE"; const doc = r.N_Doc || "SIN_DOC"; const key = ue + "||" + doc;
      if(!groups.has(key)) groups.set(key, {ue, doc, tipo: r.Tipo||"", items: []});
      groups.get(key).items.push(r);
    }
    const corte = (PARAMS && PARAMS.corte) ? PARAMS.corte : "";
    const now = new Date().toLocaleString("es-PA");
    const aoa = [];
    aoa.push(["HOJA DE ASIGNACI√ìN F8 ‚Äî CORTE DIARIO"]);
    aoa.push([`Generado: ${now}`, `Corte: ${corte}`, "Reglas: Fair Share | Prioridad: Mensual > Fecha > UE"]);
    aoa.push([]);
    // --- CAMBIO 5: AGREGADO ENCABEZADOS EXTRA EXCEL ---
    const header = ["UE", "Documento", "Tipo", "C√≥digo", "Suministro", "Solicitado", "Solic. red.", "Asignado", "Pendiente", "Bultos T/S/P", "Lotes usados", "√öltimo despacho (real)", "Qty √∫ltimo", "Promedio Hist.", "Frio", "Importancia"];
    aoa.push(header);
    for(const g of Array.from(groups.values()).sort((a,b)=> (a.ue+a.doc).localeCompare(b.ue+b.doc))){
      g.items.sort((a,b)=> String(a.Codigo||"").localeCompare(String(b.Codigo||"")));
      for(const r of g.items){
        const bults = `${fmtBultosPart(r.Bultos_Ter||0)}/${fmtBultosPart(r.Bultos_Sec||0)}/${fmtBultosPart(r.Bultos_Prim||0)}`;
        const ldFecha = r.Ultimo_Despacho || "";
        const ldQty = r.Qty_Ultimo ? Number(r.Qty_Ultimo) : "";
        const prom = r.Promedio_Hist ? Number(r.Promedio_Hist) : "";

        aoa.push([
          g.ue, g.doc, g.tipo, r.Codigo||"", r.Suministro||"", Number(r.Solicitado||0), Number(r.Solicitado_redondeado||0),
          Number(r.Asignado||0), Number(r.Pendiente||0), bults, r.Lotes_Usados||"", 
          ldFecha, ldQty, prom,
          // COLUMNAS NUEVAS EN EXCEL
          r.Frio ? "SI" : "", r.Importancia || ""
        ]);
      }
      aoa.push([]);
    }
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    ws["!cols"] = [{wch:22},{wch:18},{wch:12},{wch:12},{wch:60},{wch:12},{wch:12},{wch:12},{wch:12},{wch:14},{wch:40},{wch:18},{wch:12},{wch:12},{wch:8},{wch:12}];
    ws["!freeze"] = { xSplit: 0, ySplit: 4 };
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Asignacion_F8");
    XLSX.writeFile(wb, fileName);
  }

  // --- L√ìGICA DE CARGA DE DATOS ---
  const WEBAPP_BASE = "https://script.google.com/macros/s/AKfycbyVHDQ8IuVHibz259AiEvZ-jUfVC7fxvSSqC-wfaiiq1_13C9_TK4dVtPK0SMW4sZoJ/exec";

  function loadJsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      const script = document.createElement('script');
      script.src = `${url}&callback=${cb}&_ts=${Date.now()}`;
      script.onerror = () => reject(new Error('Script error'));
      window[cb] = (data) => { resolve(data); delete window[cb]; script.remove(); };
      document.body.appendChild(script);
    });
  }

  async function fetchAndLoad(type) {
    const isHistory = type === 'history';
    const btn = isHistory ? document.getElementById('btnLoadHistory') : document.getElementById('btnLoadDaily');
    const originalText = btn.textContent;
    btn.textContent = "Cargando...";
    document.body.style.cursor = 'wait';

    try {
      let newData;
      if (type === 'allocation') {
          const [alloc, params] = await Promise.all([
              loadJsonp(`${WEBAPP_BASE}?file=allocation`),
              loadJsonp(`${WEBAPP_BASE}?file=params`)
          ]);
          newData = alloc;
          PARAMS = params; 
          document.getElementById('mainHeader').textContent = "Asignaci√≥n F8 (Corte diario)";
          document.getElementById('cutDate').textContent = PARAMS.cut_date || "Hoy";
      } else {
          newData = await loadJsonp(`${WEBAPP_BASE}?file=history`);
          document.getElementById('mainHeader').textContent = "‚ö†Ô∏èHISTORIAL ACUMULADO‚ö†Ô∏è";
          document.getElementById('cutDate').textContent = "Hist√≥rico Completo";
      }

      if (!newData || newData.length === 0) alert("No se encontraron datos.");
      else {
          DATA = newData;
          populateFilters(); applyFilters();    
      }
    } catch (e) { console.error(e); alert("Error de conexi√≥n."); } 
    finally { btn.textContent = originalText; document.body.style.cursor = 'default'; }
  }

  async function init(){
    tickDateTime(); setInterval(tickDateTime, 60000);
    fetchAndLoad('allocation');
    
    document.getElementById('btnLoadDaily').addEventListener('click', () => fetchAndLoad('allocation'));
    document.getElementById('btnLoadHistory').addEventListener('click', () => fetchAndLoad('history'));
    
    document.getElementById('btnApply').addEventListener('click', applyFilters);
    document.getElementById('btnReset').addEventListener('click', () => {
        document.getElementById('q').value = ""; document.getElementById('doc').value = ""; document.getElementById('dateFrom').value = ""; document.getElementById('dateTo').value = ""; document.getElementById('cat').value = "ALL"; document.getElementById('ue').value = "ALL"; document.getElementById('tipo').value = "ALL"; document.getElementById('estado').value = "ALL";
        document.getElementById('allocDateFrom').value = ""; document.getElementById('allocDateTo').value = "";
        applyFilters();
    });
    
    document.getElementById('btnExportCsv').addEventListener('click', exportCsv);
    document.getElementById('btnExportPdf').addEventListener('click', exportPdfAsignacion);
    // LISTENER PARA EL NUEVO REPORTE GERENCIAL
    document.getElementById('btnExportPdfManager').addEventListener('click', exportPdfGerencial);
    document.getElementById('btnExportXlsx').addEventListener('click', exportXlsxAsignacion);
    
    document.querySelectorAll('.tab').forEach(el => el.addEventListener('click', () => showTab(el.dataset.tab)));
  }
  
  const btnLoad = document.getElementById('btnLoadLocal');
  const fileLoad = document.getElementById('fileLoad');
  if (btnLoad && fileLoad){
    btnLoad.addEventListener('click', ()=> fileLoad.click());
    fileLoad.addEventListener('change', async (ev)=>{
      const files = Array.from(ev.target.files || []);
      if (!files.length) return;
      const byName = Object.fromEntries(files.map(f=>[f.name.toLowerCase(), f]));
      async function readJson(file){ const txt = await file.text(); return JSON.parse(txt); }
      try{
        if (byName['allocation.json']) DATA = await readJson(byName['allocation.json']);
        if (byName['params.json']) PARAMS = await readJson(byName['params.json']);
        populateFilters(); applyFilters(); alert('Datos locales cargados.');
      }catch(e){ console.error(e); alert('No se pudo cargar uno de los JSON.'); }finally{ fileLoad.value = ''; }
    });
  }
  init();
</script>
</body>
</html>
