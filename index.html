<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SIGUELO - Asignación F8 (Corte diario)</title>
  <style>
    body{font-family:Arial, sans-serif; margin:0; background:#fff;}
    .topbar{
      background: linear-gradient(90deg,#0b1f3a,#133a74);
      color:#fff; padding:12px 14px; display:flex; align-items:center; gap:12px;
      box-shadow:0 2px 10px rgba(0,0,0,.2);
      position:sticky; top:0; z-index:9999; width:100%; box-sizing:border-box;
    }
    .topbar img{width:40px;height:40px;object-fit:contain;flex-shrink:0;background:transparent;}
    .topbar .title{flex:1 1 auto;min-width:200px;display:flex;flex-direction:column;line-height:1.2;}
    .topbar .title-main{font-size:16px;font-weight:700;letter-spacing:.3px;color:#fff;}
    .topbar .title-sub{font-size:12px;font-weight:400;color:#cbd5e1;margin-top:2px;}
    .topbar .top-actions{display:flex;gap:8px;align-items:center;flex:0 0 auto;}
    .topbar .theme-select{padding:6px 8px;border:1px solid rgba(255,255,255,.25);border-radius:10px;background:transparent;color:#fff;min-width:110px;}
    .topbar .theme-select option{background:#0b1f3a;color:#fff;}
    @media (max-width:720px){
      .topbar{flex-direction:column;align-items:center;text-align:center;position:static;}
      .topbar .top-actions{width:100%;justify-content:center;margin-top:8px;}
      .topbar .theme-select{width:100%;max-width:220px;}
    }
    .page{padding:18px;}
    .grid{display:grid;grid-template-columns:420px 1fr;gap:12px;align-items:start;}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#fff;}
    h1{font-size:18px;margin:0 0 8px 0;}
    h2{font-size:14px;margin:0 0 8px 0;}
    label{display:block;font-size:12px;margin-top:6px;}
    select,input{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;box-sizing:border-box;}
    button{padding:9px 12px;border:1px solid #333;border-radius:10px;background:#fff;cursor:pointer;}
    button:disabled{opacity:.5;cursor:not-allowed;}
    .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}
    .kpi .box{border:1px solid #e5e5e5;border-radius:10px;padding:10px;}
    .kpi .value{font-size:16px;font-weight:700;margin-top:6px;}
    .muted{color:#666;font-size:12px;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .tab{border:1px solid #ddd;border-radius:999px;padding:7px 10px;font-size:12px;cursor:pointer;user-select:none;background:#fff;}
    .tab.active{border-color:#333;font-weight:700;}
    table{border-collapse:collapse;width:100%;font-size:12px;}
    th,td{border:1px solid #ddd;padding:6px;vertical-align:top;}
    th{background:#f7f7f7;position:sticky;top:0;z-index:1;}
    .scroll{max-height:62vh;overflow:auto;border:1px solid #ddd;border-radius:10px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .row > *{flex:1 1 auto;}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:2px 8px;font-size:12px;}
    .right{text-align:right;}
    .center{text-align:center;}
    .danger{color:#b00020;}
    .ok{color:#0a7a2f;}
  </style>
</head>
<body>
  <div class="topbar">
    <img src="icons/icon-512.png" alt="Logo" width="40" height="40" onerror="this.style.display='none'">
    <div class="title">
      <div class="title-main">SIGUELO — Asignación de pedidos F8</div>
      <div class="title-sub">
        <span id="currentDateTime">Cargando fecha...</span>
        <span style="opacity:.8;margin-left:8px;"> | C1 Corte diario · v1.3</span>
      </div>
    </div>
    <div class="top-actions">
      <select id="themeMode" class="theme-select" title="Tema">
        <option value="auto">Sistema</option>
        <option value="light">Claro</option>
        <option value="dark">Oscuro</option>
      </select>
    </div>
  </div>

  <div class="page">
    <h1>Asignación F8 (Corte diario)</h1>
    <div class="muted">
      Corte: <span id="cutDate"></span> · Lotes elegibles: vencimiento ≥ <span id="minVto"></span> ·
      Excluye Tipo = <b>TRANSFERENCIA</b> · Orden: prioridad UE → fecha (reciente a antiguo)
    </div>

    <div class="grid" style="margin-top:12px;">
      <div class="card">
        <h2>Filtros</h2>
        <label>Buscar (Código o texto de suministro)</label>
        <input id="q" placeholder="Ej: 101000201 o metformina"/>
        <label>Categoría UE</label>
        <select id="cat"></select>
        <label>Punto de Información (UE)</label>
        <select id="ue"></select>
        <label>Tipo</label>
        <select id="tipo"></select>
        <label>Estado de cobertura</label>
        <select id="estado">
          <option value="ALL">Todos</option>
          <option value="COMPLETO">Completo</option>
          <option value="PARCIAL">Parcial</option>
          <option value="SIN">Sin stock</option>
        </select>
        <div class="row" style="margin-top:10px;">
          <button id="btnApply">Aplicar</button>
          <button id="btnReset">Reset</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <button id="btnExport">Exportar (pestaña actual)</button>
        </div>
        <div class="muted" style="margin-top:10px;">
          Nota: solicitado original se mantiene. Solicitado redondeado es el operable (redondeo hacia abajo por empaque, con fallback si falta empaque). Último despacho real proviene de PERIODO DE DISTRIBUCIÓN (Fecha SALIDA + DESPACHO).
        </div>
      </div>

      <div class="card">
        <h2>KPIs (vista filtrada)</h2>
        <div class="kpi">
          <div class="box"><div class="muted">Líneas</div><div class="value" id="k_lines">-</div></div>
          <div class="box"><div class="muted">Solicitado (original)</div><div class="value" id="k_req">-</div></div>
          <div class="box"><div class="muted">Solicitado (redondeado)</div><div class="value" id="k_req_r">-</div></div>
          <div class="box"><div class="muted">Asignado</div><div class="value" id="k_assigned">-</div></div>
          <div class="box"><div class="muted">Fill rate</div><div class="value" id="k_fill">-</div></div>
        </div>

        <div class="tabs" role="tablist" aria-label="Pestañas">
          <div class="tab active" data-tab="asignacion">Asignación</div>
          <div class="tab" data-tab="ue_sin">UEs sin cobertura</div>
          <div class="tab" data-tab="sku_sin">SKUs críticos sin stock</div>
          <div class="tab" data-tab="invalidos">Pedidos inválidos</div>
          <div class="tab" data-tab="fill_cat">Fill rate por categoría</div>
        </div>

        <div id="viewTitle" style="margin-top:10px;font-weight:700;">Asignación (líneas SALMI)</div>
        <div class="muted" id="viewHint" style="margin-top:4px;">
          Hoja operativa para reemplazar el empirismo. Incluye solicitado original, redondeado, asignación FEFO, lotes y último despacho (fecha + cantidad).
        </div>

        <div id="view_asignacion" class="view" style="margin-top:10px;">
          <div class="scroll">
            <table id="tbl_asignacion">
              <thead>
                <tr>
                  <th>Fecha</th><th>Doc</th><th>Tipo</th><th>UE</th><th>Categoría</th>
                  <th>Código</th><th>Suministro</th>
                  <th class="right">Solicitado</th><th class="right">Solic. red.</th>
                  <th class="right">Asignado</th><th class="right">Pendiente</th>
                  <th class="center">Bultos (T/S/P)</th><th>Lotes usados</th>
                  <th>Último despacho (real)</th><th class="right">Qty último</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="view_ue_sin" class="view" style="display:none;margin-top:10px;">
          <div class="scroll">
            <table id="tbl_ue_sin">
              <thead>
                <tr>
                  <th>UE</th><th>Categoría</th>
                  <th class="right">Líneas sin cobertura</th>
                  <th class="right">Solicitado (original)</th>
                  <th class="right">Solicitado (red.)</th>
                  <th>Pedido más reciente</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="view_sku_sin" class="view" style="display:none;margin-top:10px;">
          <div class="scroll">
            <table id="tbl_sku_sin">
              <thead>
                <tr>
                  <th>Código</th><th>Suministro</th>
                  <th class="right">Solicitado (original)</th>
                  <th class="right">Solicitado (red.)</th>
                  <th class="right">Nº UEs</th>
                  <th>Categorías afectadas</th>
                  <th>Último despacho (real)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="view_invalidos" class="view" style="display:none;margin-top:10px;">
          <div class="scroll">
            <table id="tbl_invalidos">
              <thead>
                <tr>
                  <th>Fecha</th><th>UE</th><th>Categoría</th><th>Código</th><th>Suministro</th>
                  <th class="right">Solicitado (original)</th>
                  <th class="right">Empaque terciario</th>
                  <th class="right">Solicitado (red.)</th>
                  <th>Motivo</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="muted" style="margin-top:8px;">
            Nota: estos registros explican demanda no operable (por empaque) y deben usarse para corrección del proceso de solicitud en UEs.
          </div>
        </div>

        <div id="view_fill_cat" class="view" style="display:none;margin-top:10px;">
          <div class="scroll">
            <table id="tbl_fill_cat">
              <thead>
                <tr>
                  <th>Categoría</th>
                  <th class="right">Líneas</th>
                  <th class="right">Solicitado (original)</th>
                  <th class="right">Solicitado (red.)</th>
                  <th class="right">Asignado</th>
                  <th class="right">Fill rate</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="muted" style="margin-top:10px;">
          Si la UE aparece como <span class="pill">SIN_CATEGORIA</span>, revisa <b>ue_alias.json</b> y agrega el alias correspondiente en tu catálogo.
        </div>

      </div>
    </div>
  </div>

<script>
const fmt = (n) => {
  if (n === null || n === undefined || isNaN(n)) return "-";
  return new Intl.NumberFormat('es-PA', {maximumFractionDigits: 0}).format(n);
};

function tickDateTime(){
  const el = document.getElementById('currentDateTime');
  if(!el) return;
  const now = new Date();
  const opts = { weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit' };
  el.textContent = now.toLocaleString('es-PA', opts);
}

let DATA = [];
let PARAMS = {};
let LAST = {};
let ACTIVE_TAB = "asignacion";
let LAST_FILTERED = [];

function uniq(arr){ return [...new Set(arr)].filter(x => x !== null && x !== undefined); }
function parseISODate(s){
  if(!s) return null;
  const m = String(s).match(/(\d{4})-(\d{2})-(\d{2})/);
  if(!m) return null;
  return new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00`);
}

function coverage(r){
  const req = Number(r.Solicitado_redondeado || 0);
  const asg = Number(r.Asignado || 0);
  if (asg <= 0) return "SIN";
  if (asg >= req && req > 0) return "COMPLETO";
  return "PARCIAL";
}

function populateFilters(){
  const catSel = document.getElementById('cat');
  const ueSel = document.getElementById('ue');
  const tipoSel = document.getElementById('tipo');

  const cats = ["ALL", ...uniq(DATA.map(r => r.Categoria)).sort()];
  catSel.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join("");

  const ues = ["ALL", ...uniq(DATA.map(r => r.Punto)).sort()];
  ueSel.innerHTML = ues.map(u => `<option value="${u}">${u}</option>`).join("");

  const tipos = ["ALL", ...uniq(DATA.map(r => r.Tipo)).sort()];
  tipoSel.innerHTML = tipos.map(t => `<option value="${t}">${t}</option>`).join("");
}

function applyFilters(){
  const q = (document.getElementById('q').value || "").trim().toLowerCase();
  const cat = document.getElementById('cat').value;
  const ue = document.getElementById('ue').value;
  const tipo = document.getElementById('tipo').value;
  const estado = document.getElementById('estado').value;

  let rows = DATA;
  if (q) rows = rows.filter(r => String(r.Codigo).includes(q) || String(r.Suministro || "").toLowerCase().includes(q));
  if (cat !== "ALL") rows = rows.filter(r => r.Categoria === cat);
  if (ue !== "ALL") rows = rows.filter(r => r.Punto === ue);
  if (tipo !== "ALL") rows = rows.filter(r => r.Tipo === tipo);
  if (estado !== "ALL") rows = rows.filter(r => coverage(r) === estado);

  LAST_FILTERED = rows;
  renderKPIs(rows);
  renderActiveTab(rows);
}

function renderKPIs(rows){
  const req = rows.reduce((a,r)=>a + Number(r.Solicitado||0), 0);
  const reqR = rows.reduce((a,r)=>a + Number(r.Solicitado_redondeado||0), 0);
  const asg = rows.reduce((a,r)=>a + Number(r.Asignado||0), 0);
  const fill = reqR > 0 ? (asg/reqR)*100 : 0;

  document.getElementById('k_lines').textContent = fmt(rows.length);
  document.getElementById('k_req').textContent = fmt(req);
  document.getElementById('k_req_r').textContent = fmt(reqR);
  document.getElementById('k_assigned').textContent = fmt(asg);
  document.getElementById('k_fill').textContent = `${fill.toFixed(1)}%`;
}

function showTab(tab){
  ACTIVE_TAB = tab;
  document.querySelectorAll('.tab').forEach(el => el.classList.toggle('active', el.dataset.tab === tab));
  document.querySelectorAll('.view').forEach(v => v.style.display = "none");
  document.getElementById(`view_${tab}`).style.display = "block";

  const title = document.getElementById('viewTitle');
  const hint = document.getElementById('viewHint');
  const meta = {
    asignacion: ["Asignación (líneas SALMI)", "Hoja operativa para reemplazar el empirismo. Incluye solicitado original, redondeado, asignación FEFO, lotes y último despacho (fecha + cantidad)."],
    ue_sin: ["UEs sin cobertura (Top 20)", "UEs con asignación 0 y solicitado redondeado > 0. Útil para justificar faltantes y priorizar atención por jerarquía."],
    sku_sin: ["SKUs críticos sin stock (Top 20)", "Productos con asignación 0 y demanda operable > 0. Útil para compras/abastecimiento."],
    invalidos: ["Pedidos inválidos por empaque", "Demanda no operable (por empaque) que fuerza empirismo. Útil para corregir solicitudes."],
    fill_cat: ["Fill rate por categoría UE", "Cobertura (Asignado / Solicitado redondeado) agrupada por categoría UE."]
  };
  title.textContent = meta[tab][0];
  hint.textContent = meta[tab][1];

  renderActiveTab(LAST_FILTERED.length ? LAST_FILTERED : DATA);
}

function lastKey(r){
  return `${String(r.Punto||"").trim()}|${String(r.Codigo||"").trim()}`;
}
function getLastDispatch(r){
  const hit = LAST[lastKey(r)];
  if(!hit) return {fecha:"-", qty:null};
  return {fecha: (hit.fecha || "-"), qty: hit.qty};
}

function renderAsignacion(rows){
  const tb = document.querySelector("#tbl_asignacion tbody");
  tb.innerHTML = rows.slice(0, 2000).map(r => {
    const b = `${(r.Bultos_Ter||0).toFixed(2)}/${(r.Bultos_Sec||0).toFixed(2)}/${(r.Bultos_Prim||0).toFixed(2)}`;
    const lots = r.Lotes_Usados ? r.Lotes_Usados : "";
    const ld = getLastDispatch(r);
    return `<tr>
      <td>${r.Fecha||""}</td>
      <td>${r.N_Doc||""}</td>
      <td>${r.Tipo||""}</td>
      <td>${r.Punto||""}</td>
      <td>${r.Categoria||""}</td>
      <td>${r.Codigo||""}</td>
      <td>${r.Suministro||""}</td>
      <td class="right">${fmt(r.Solicitado)}</td>
      <td class="right">${fmt(r.Solicitado_redondeado)}</td>
      <td class="right">${fmt(r.Asignado)}</td>
      <td class="right">${fmt(r.Pendiente)}</td>
      <td class="center">${b}</td>
      <td>${lots}</td>
      <td>${ld.fecha || "-"}</td>
      <td class="right">${ld.qty === null || ld.qty === undefined ? "-" : fmt(ld.qty)}</td>
    </tr>`;
  }).join("");
  window.__exportRows = rows;
  window.__exportName = "asignacion";
}

function renderUESin(rows){
  const filtered = rows.filter(r => Number(r.Asignado||0) === 0 && Number(r.Solicitado_redondeado||0) > 0);
  const map = new Map();
  for(const r of filtered){
    const key = `${r.Punto||""}||${r.Categoria||""}`;
    if(!map.has(key)) map.set(key, {UE:r.Punto||"", Categoria:r.Categoria||"", lineas:0, sol:0, solr:0, fechaMax:null});
    const o = map.get(key);
    o.lineas += 1;
    o.sol += Number(r.Solicitado||0);
    o.solr += Number(r.Solicitado_redondeado||0);
    const d = parseISODate(r.Fecha);
    if(d && (!o.fechaMax || d > o.fechaMax)) o.fechaMax = d;
  }
  const out = [...map.values()].map(o => ({
    UE:o.UE, Categoria:o.Categoria, Lineas_sin_cobertura:o.lineas,
    Solicitado_original:o.sol, Solicitado_redondeado:o.solr,
    Pedido_mas_reciente:o.fechaMax ? o.fechaMax.toISOString().slice(0,10) : ""
  })).sort((a,b)=> (b.Solicitado_redondeado - a.Solicitado_redondeado) || (b.Lineas_sin_cobertura - a.Lineas_sin_cobertura))
    .slice(0,20);

  const tb = document.querySelector("#tbl_ue_sin tbody");
  tb.innerHTML = out.map(r => `<tr>
    <td>${r.UE}</td>
    <td>${r.Categoria}</td>
    <td class="right">${fmt(r.Lineas_sin_cobertura)}</td>
    <td class="right">${fmt(r.Solicitado_original)}</td>
    <td class="right">${fmt(r.Solicitado_redondeado)}</td>
    <td>${r.Pedido_mas_reciente}</td>
  </tr>`).join("");

  window.__exportRows = out;
  window.__exportName = "ue_sin_cobertura_top20";
}

function renderSKUSin(rows){
  const filtered = rows.filter(r => Number(r.Asignado||0) === 0 && Number(r.Solicitado_redondeado||0) > 0);
  const map = new Map();
  for(const r of filtered){
    const code = String(r.Codigo||"");
    const key = `${code}||${String(r.Suministro||"")}`;
    if(!map.has(key)) map.set(key, {Codigo:code, Suministro:String(r.Suministro||""), sol:0, solr:0, ues:new Set(), cats:new Set(), last:null});
    const o = map.get(key);
    o.sol += Number(r.Solicitado||0);
    o.solr += Number(r.Solicitado_redondeado||0);
    o.ues.add(String(r.Punto||""));
    o.cats.add(String(r.Categoria||""));
    const ld = getLastDispatch(r);
    if(ld && ld.fecha && ld.fecha !== "-"){
      const d = parseISODate(ld.fecha);
      if(d && (!o.last || d > o.last)) o.last = d;
    }
  }
  const out = [...map.values()].map(o => ({
    Codigo:o.Codigo,
    Suministro:o.Suministro,
    Solicitado_original:o.sol,
    Solicitado_redondeado:o.solr,
    Num_UEs:o.ues.size,
    Categorias_afectadas:[...o.cats].filter(x=>x).sort().join(", "),
    Ultimo_despacho_real:o.last ? o.last.toISOString().slice(0,10) : ""
  })).sort((a,b)=> (b.Solicitado_redondeado - a.Solicitado_redondeado) || (b.Num_UEs - a.Num_UEs))
    .slice(0,20);

  const tb = document.querySelector("#tbl_sku_sin tbody");
  tb.innerHTML = out.map(r => `<tr>
    <td>${r.Codigo}</td>
    <td>${r.Suministro}</td>
    <td class="right">${fmt(r.Solicitado_original)}</td>
    <td class="right">${fmt(r.Solicitado_redondeado)}</td>
    <td class="right">${fmt(r.Num_UEs)}</td>
    <td>${r.Categorias_afectadas}</td>
    <td>${r.Ultimo_despacho_real || "-"}</td>
  </tr>`).join("");

  window.__exportRows = out;
  window.__exportName = "skus_criticos_sin_stock_top20";
}

function renderInvalidos(rows){
  const filtered = rows.filter(r => Number(r.Solicitado||0) > 0 && Number(r.Solicitado_redondeado||0) === 0);
  const out = filtered.slice().sort((a,b)=>{
    const da = parseISODate(a.Fecha); const db = parseISODate(b.Fecha);
    return (db - da);
  }).slice(0,2000).map(r => {
    const sol = Number(r.Solicitado||0);
    const empT = (r.Emp_Ter === null || r.Emp_Ter === undefined || r.Emp_Ter === "") ? null : Number(r.Emp_Ter);
    let motivo = "Solicitado redondeado = 0";
    if(empT && sol < empT) motivo = "Solicitado menor a empaque terciario";
    else if(empT && (sol % empT) !== 0) motivo = "Solicitado no es múltiplo del empaque terciario";
    else if(!empT) motivo = "Sin empaque terciario definido (fallback aplicado)";
    return {
      Fecha:r.Fecha||"",
      UE:r.Punto||"",
      Categoria:r.Categoria||"",
      Codigo:r.Codigo||"",
      Suministro:r.Suministro||"",
      Solicitado_original:sol,
      Empaque_terciario:empT,
      Solicitado_redondeado:Number(r.Solicitado_redondeado||0),
      Motivo:motivo
    };
  });

  const tb = document.querySelector("#tbl_invalidos tbody");
  tb.innerHTML = out.map(r => `<tr>
    <td>${r.Fecha}</td>
    <td>${r.UE}</td>
    <td>${r.Categoria}</td>
    <td>${r.Codigo}</td>
    <td>${r.Suministro}</td>
    <td class="right">${fmt(r.Solicitado_original)}</td>
    <td class="right">${r.Empaque_terciario === null ? "-" : fmt(r.Empaque_terciario)}</td>
    <td class="right">${fmt(r.Solicitado_redondeado)}</td>
    <td class="${r.Motivo.includes("menor") ? "danger" : ""}">${r.Motivo}</td>
  </tr>`).join("");

  window.__exportRows = out;
  window.__exportName = "pedidos_invalidos_por_empaque";
}

function renderFillCat(rows){
  const map = new Map();
  for(const r of rows){
    const cat = String(r.Categoria||"");
    if(!map.has(cat)) map.set(cat, {Categoria:cat, lineas:0, sol:0, solr:0, asg:0});
    const o = map.get(cat);
    o.lineas += 1;
    o.sol += Number(r.Solicitado||0);
    o.solr += Number(r.Solicitado_redondeado||0);
    o.asg += Number(r.Asignado||0);
  }
  const out = [...map.values()].map(o => ({
    Categoria:o.Categoria,
    Lineas:o.lineas,
    Solicitado_original:o.sol,
    Solicitado_redondeado:o.solr,
    Asignado:o.asg,
    Fill_rate: o.solr > 0 ? (o.asg/o.solr) : 0
  })).sort((a,b)=> (a.Categoria||"").localeCompare(b.Categoria||""));

  const tb = document.querySelector("#tbl_fill_cat tbody");
  tb.innerHTML = out.map(r => `<tr>
    <td>${r.Categoria}</td>
    <td class="right">${fmt(r.Lineas)}</td>
    <td class="right">${fmt(r.Solicitado_original)}</td>
    <td class="right">${fmt(r.Solicitado_redondeado)}</td>
    <td class="right">${fmt(r.Asignado)}</td>
    <td class="right">${(r.Fill_rate*100).toFixed(1)}%</td>
  </tr>`).join("");

  window.__exportRows = out;
  window.__exportName = "fill_rate_por_categoria";
}

function renderActiveTab(rows){
  if(ACTIVE_TAB === "asignacion") return renderAsignacion(rows);
  if(ACTIVE_TAB === "ue_sin") return renderUESin(rows);
  if(ACTIVE_TAB === "sku_sin") return renderSKUSin(rows);
  if(ACTIVE_TAB === "invalidos") return renderInvalidos(rows);
  if(ACTIVE_TAB === "fill_cat") return renderFillCat(rows);
}

function exportCsv(){
  const rows = window.__exportRows || [];
  const cols = Object.keys(rows[0] || {});
  if (!cols.length) return;

  const esc = (v) => {
    const s = (v === null || v === undefined) ? "" : String(v);
    if (s.includes('"') || s.includes(",") || s.includes("\n")) return '"' + s.replaceAll('"','""') + '"';
    return s;
  };
  const csv = [cols.join(",")].concat(rows.map(r => cols.map(c => esc(r[c])).join(","))).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${window.__exportName || "export"}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function init(){
  tickDateTime();
  setInterval(tickDateTime, 60000);

  const [dataRes, paramsRes, lastRes] = await Promise.all([
    fetch("./allocation.json"),
    fetch("./params.json"),
    fetch("./last_dispatch.json")
  ]);
  DATA = await dataRes.json();
  PARAMS = await paramsRes.json();
  LAST = await lastRes.json();

  document.getElementById('cutDate').textContent = PARAMS.cut_date || "-";
  document.getElementById('minVto').textContent = PARAMS.min_vto || "-";

  populateFilters();
  LAST_FILTERED = DATA;
  renderKPIs(DATA);
  showTab("asignacion");

  document.getElementById('btnApply').addEventListener('click', applyFilters);
  document.getElementById('btnReset').addEventListener('click', () => {
    document.getElementById('q').value = "";
    document.getElementById('cat').value = "ALL";
    document.getElementById('ue').value = "ALL";
    document.getElementById('tipo').value = "ALL";
    document.getElementById('estado').value = "ALL";
    LAST_FILTERED = DATA;
    renderKPIs(DATA);
    renderActiveTab(DATA);
  });
  document.getElementById('btnExport').addEventListener('click', exportCsv);
  document.querySelectorAll('.tab').forEach(el => el.addEventListener('click', () => showTab(el.dataset.tab)));
}
init();
</script>
</body>
</html>
