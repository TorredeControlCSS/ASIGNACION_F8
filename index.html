<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="./favicon.ico?v=1"/>
  <link rel="shortcut icon" href="./favicon.ico?v=1"/>
  <title>SIGUELO - Asignaci√≥n F8 (Corte diario)</title>
  <style>
    body{font-family:Arial, sans-serif; margin:0; background:#fff;}
    .topbar{
      background: linear-gradient(90deg,#0b1f3a,#133a74);
      color:#fff; padding:12px 14px; display:flex; align-items:center; gap:12px;
      box-shadow:0 2px 10px rgba(0,0,0,.2);
      position:sticky; top:0; z-index:9999; width:100%; box-sizing:border-box;
    }
    .topbar img{width:40px;height:40px;object-fit:contain;flex-shrink:0;background:transparent;}
    .topbar .title{flex:1 1 auto;min-width:200px;display:flex;flex-direction:column;line-height:1.2;}
    .topbar .title-main{font-size:16px;font-weight:700;letter-spacing:.3px;color:#fff;}
    .topbar .title-sub{font-size:12px;font-weight:400;color:#cbd5e1;margin-top:2px;}
    .topbar .top-actions{display:flex;gap:8px;align-items:center;flex:0 0 auto;}
    .topbar .theme-select{padding:6px 8px;border:1px solid rgba(255,255,255,.25);border-radius:10px;background:transparent;color:#fff;min-width:110px;}
    .topbar .theme-select option{background:#0b1f3a;color:#fff;}
    @media (max-width:720px){
      .topbar{flex-direction:column;align-items:center;text-align:center;position:static;}
      .topbar .top-actions{width:100%;justify-content:center;margin-top:8px;}
      .topbar .theme-select{width:100%;max-width:220px;}
    }
    .page{padding:18px;}
    .grid{display:grid;grid-template-columns:420px 1fr;gap:12px;align-items:start;}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#fff;}
    h1{font-size:18px;margin:0 0 8px 0;}
    h2{font-size:14px;margin:0 0 8px 0;}
    label{display:block;font-size:12px;margin-top:6px;}
    select,input{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;box-sizing:border-box;}
    button{padding:9px 12px;border:1px solid #333;border-radius:10px;background:#fff;cursor:pointer;}
    button:disabled{opacity:.5;cursor:not-allowed;}
    .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}
    .kpi .box{border:1px solid #e5e5e5;border-radius:10px;padding:10px;}
    .kpi .value{font-size:16px;font-weight:700;margin-top:6px;}
    .muted{color:#666;font-size:12px;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .tab{border:1px solid #ddd;border-radius:999px;padding:7px 10px;font-size:12px;cursor:pointer;user-select:none;background:#fff;}
    .tab.active{border-color:#333;font-weight:700;}
    table{border-collapse:collapse;width:100%;font-size:12px;}
    th,td{border:1px solid #ddd;padding:6px;vertical-align:top;}
    th{background:#f7f7f7;position:sticky;top:0;z-index:1;}
    .scroll{max-height:62vh;overflow:auto;border:1px solid #ddd;border-radius:10px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .row > *{flex:1 1 auto;}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:2px 8px;font-size:12px;}
    .right{text-align:right;}
    .center{text-align:center;}
    .danger{color:#b00020;}
    .ok{color:#0a7a2f;}
    
    /* Botones especiales */
    .btn-main { background: #0b1f3a; color: white; border: none; font-weight:700;}
    .btn-daily { background: #0a7a2f; color: white; border: none; }
    .btn-history { background: #444; color: white; border: none; }
    .btn-secondary { background: #f0f0f0; color: #333; border: 1px solid #ccc; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="topbar">
    <img src="icons/icon-512.png" alt="Logo" width="40" height="40" onerror="this.style.display='none'">
    <div class="title">
      <div class="title-main">SIGUELO ‚Äî Motor de Asignaci√≥n de Requisiciones F8</div>
      <div class="title-sub">
        <span id="currentDateTime">Cargando fecha...</span>
        <span style="opacity:.8;margin-left:8px;"> | C1 Corte diario ¬∑ v5.2 Full</span>
      </div>
    </div>
    <div class="top-actions">
      <select id="themeMode" class="theme-select" title="Tema">
        <option value="auto">Sistema</option>
        <option value="light">Claro</option>
        <option value="dark">Oscuro</option>
      </select>
    </div>
  </div>

  <div class="page">
    <h1><span id="mainHeader">Asignaci√≥n F8 (Corte diario)</span></h1>
    <div class="muted">
      Corte: <span id="cutDate"></span> ¬∑ Lotes elegibles: vencimiento ‚â• 30 dias <span id="minVto"></span> ¬∑
      Prioridad UE: <b>CEDIS > Hospital > Policl√≠nica > ULAPS > CAPPS</b>
    </div>

    <div class="grid" style="margin-top:12px;">
      <div class="card">
        <h2>Filtros</h2>
        <label>Buscar (C√≥digo o texto de suministro)</label>
        <input id="q" placeholder="Ej: 101000201 o metformina"/>
        
        <label>Documento (Doc)</label>
        <input id="doc" class="input" placeholder="Ej: CDCH-2025-1-417" list="docList" autocomplete="off"/>
        <datalist id="docList"></datalist>

        <!-- 1. FILTRO ORIGINAL: FECHA DEL DOCUMENTO F8 -->
        <div class="row2" style="display:flex; gap:10px; margin-top:5px;">
          <div style="flex:1;">
            <label>Fecha Doc F8 (Desde)</label>
            <input id="dateFrom" class="input" type="date"/>
          </div>
          <div style="flex:1;">
            <label>Fecha Doc F8 (Hasta)</label>
            <input id="dateTo" class="input" type="date"/>
          </div>
        </div>

        <!-- 2. NUEVO FILTRO: FECHA DE EJECUCI√ìN/ASIGNACI√ìN -->
        <div class="row2" style="display:flex; gap:10px; margin-top:5px; margin-bottom:10px; padding-top:5px; border-top:1px dashed #eee;">
          <div style="flex:1;">
            <label style="color:#0a7a2f; font-weight:bold;">Fecha Proceso/Asig (Desde)</label>
            <input id="allocDateFrom" class="input" type="date"/>
          </div>
          <div style="flex:1;">
            <label style="color:#0a7a2f; font-weight:bold;">Fecha Proceso/Asig (Hasta)</label>
            <input id="allocDateTo" class="input" type="date"/>
          </div>
        </div>

        <label>Categor√≠a UE</label>
        <select id="cat"></select>
        <label>Punto de Informaci√≥n (UE)</label>
        <select id="ue"></select>
        <label>Tipo</label>
        <select id="tipo"></select>
        <label>Estado de cobertura</label>
        <select id="estado">
          <option value="ALL">Todos</option>
          <option value="COMPLETO">Completo</option>
          <option value="PARCIAL">Parcial</option>
          <option value="SIN">Sin stock</option>
        </select>
        
        <div class="row" style="margin-top:10px;">
          <button id="btnApply">Aplicar</button>
          <button id="btnReset">Reset</button>
        </div>
        
        <div class="row" style="margin-top:10px;">
          <button id="btnExportPdf" class="btn-main">üìÑ Exportar PDF (Hoja de Asignaci√≥n)</button>
        </div>
        
        <div class="row" style="margin-top:10px;">
          <button id="btnExportXlsx">Exportar Excel</button>
          <button id="btnExportCsv">Exportar CSV</button>
        </div>
        
        <div class="row" style="margin-top:10px;">
          <button id="btnLoadDaily" class="btn-daily">üîÑ Ver Corte Diario</button>
          <button id="btnLoadHistory" class="btn-history">üìÇ Ver Hist√≥rico</button>
          
          <button id="btnLoadLocal" class="btn-secondary">Cargar local</button>
          <input id="fileLoad" type="file" multiple accept=".json" style="display:none"/>
        </div>

        <div class="muted" style="margin-top:10px;">
          Nota: "Solicitado redondeado" es el operable. En escasez, se aplica recorte proporcional (Fair Share).
        </div>
      </div>

      <div class="card">
        <h2>KPIs (vista filtrada)</h2>
        <div class="kpi">
          <div class="box"><div class="muted">L√≠neas</div><div class="value" id="k_lines">-</div></div>
          <div class="box"><div class="muted">Solicitado (original)</div><div class="value" id="k_req">-</div></div>
          <div class="box"><div class="muted">Solicitado (redondeado)</div><div class="value" id="k_req_r">-</div></div>
          <div class="box"><div class="muted">Asignado</div><div class="value" id="k_assigned">-</div></div>
          <div class="box"><div class="muted">Fill rate (vs Original)</div><div class="value" id="k_fill">-</div></div>
        </div>

        <div class="tabs" role="tablist" aria-label="Pesta√±as">
          <div class="tab active" data-tab="asignacion">Asignaci√≥n</div>
          <div class="tab" data-tab="ue_sin">UEs sin cobertura</div>
          <div class="tab" data-tab="sku_sin">SKUs cr√≠ticos sin stock</div>
          <div class="tab" data-tab="invalidos">Pedidos inv√°lidos</div>
          <div class="tab" data-tab="fill_cat">Fill rate por categor√≠a</div>
        </div>

        <div id="viewTitle" style="margin-top:10px;font-weight:700;">Asignaci√≥n (l√≠neas SALMI)</div>
        <div class="muted" id="viewHint" style="margin-top:4px;">
          Hoja operativa para reemplazar el empirismo. Incluye lotes, datos hist√≥ricos y promedio.
        </div>

        <div id="view_asignacion" class="view" style="margin-top:10px;">
          <div class="scroll">
            <table id="tbl_asignacion">
              <thead>
                <tr>
                  <th>Fecha F8</th><th>Doc</th><th>Tipo</th><th>UE</th><th>Categor√≠a</th>
                  <th>C√≥digo</th><th>Suministro</th>
                  <th class="right">Solicitado</th><th class="right">Solic. red.</th>
                  <th class="right">Asignado</th><th class="right">Pendiente</th>
                  <th class="center">Bultos (T/S/P)</th><th>Lotes usados</th>
                  <th>√öltimo despacho</th><th class="right">Qty √∫ltimo</th>
                  <th class="right">Promedio Hist.</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- PESTA√ëAS OCULTAS -->
        <div id="view_ue_sin" class="view" style="display:none;margin-top:10px;">
          <div class="scroll"><table id="tbl_ue_sin"><thead><tr><th>UE</th><th>Categor√≠a</th><th class="right">L√≠neas sin cobertura</th><th class="right">Solicitado (original)</th><th class="right">Solicitado (red.)</th><th>Pedido m√°s reciente</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div id="view_sku_sin" class="view" style="display:none;margin-top:10px;">
          <div class="scroll"><table id="tbl_sku_sin"><thead><tr><th>C√≥digo</th><th>Suministro</th><th class="right">Solicitado (original)</th><th class="right">Solicitado (red.)</th><th class="right">N¬∫ UEs</th><th>Categor√≠as afectadas</th><th>√öltimo despacho (real)</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div id="view_invalidos" class="view" style="display:none;margin-top:10px;">
          <div class="scroll"><table id="tbl_invalidos"><thead><tr><th>Fecha</th><th>UE</th><th>Categor√≠a</th><th>C√≥digo</th><th>Suministro</th><th class="right">Solicitado (original)</th><th class="right">Empaque terciario</th><th class="right">Solicitado (red.)</th><th>Motivo</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div id="view_fill_cat" class="view" style="display:none;margin-top:10px;">
          <div class="scroll"><table id="tbl_fill_cat"><thead><tr><th>Categor√≠a</th><th class="right">L√≠neas</th><th class="right">Solicitado (original)</th><th class="right">Solicitado (red.)</th><th class="right">Asignado</th><th class="right">Fill rate</th></tr></thead><tbody></tbody></table></div>
        </div>

        <div class="muted" style="margin-top:10px;">
          Si la UE aparece como <span class="pill">SIN_CATEGORIA</span>, revisa <b>ue_alias.json</b>.
        </div>
      </div>
    </div>
  </div>

<script>
  // --- UTILS ---
  function uniq(arr){ return [...new Set(arr)].filter(x => x !== null && x !== undefined); }
  function parseISODate(s){ if(!s) return null; const m = String(s).match(/(\d{4})-(\d{2})-(\d{2})/); if(!m) return null; return new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00`); }
  function fmtBultosPart(n){ const x = Number(n); if(!Number.isFinite(x)) return "0"; return Math.abs(x - Math.round(x)) < 1e-9 ? String(Math.round(x)) : String(parseFloat(x.toFixed(3))); }
  function fmtBultosTriple(t,s,p){ return `${fmtBultosPart(t)}/${fmtBultosPart(s)}/${fmtBultosPart(p)}`; }
  const fmt = (n) => { if (n === null || n === undefined || isNaN(n)) return "-"; return new Intl.NumberFormat('es-PA', {maximumFractionDigits: 0}).format(n); };
  
  function tickDateTime(){
    const el = document.getElementById('currentDateTime');
    if(el) el.textContent = new Date().toLocaleString('es-PA', { weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit' });
  }

  // --- VARIABLES ---
  let DATA = [];
  let PARAMS = {};
  let UE_ALIAS = [];
  let ACTIVE_TAB = "asignacion";
  let LAST_FILTERED = [];

  function coverage(r){
    const req = Number(r.Solicitado_redondeado || 0);
    const asg = Number(r.Asignado || 0);
    if (asg <= 0) return "SIN";
    if (asg >= req && req > 0) return "COMPLETO";
    return "PARCIAL";
  }

  function populateFilters(){
    const catSel = document.getElementById('cat');
    const ueSel = document.getElementById('ue');
    const tipoSel = document.getElementById('tipo');
    const docList = document.getElementById('docList');
    const cats = ["ALL", ...uniq(DATA.map(r => r.Categoria)).sort()];
    catSel.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join("");
    const ues = ["ALL", ...uniq(DATA.map(r => r.Punto)).sort()];
    ueSel.innerHTML = ues.map(u => `<option value="${u}">${u}</option>`).join("");
    const tipos = ["ALL", ...uniq(DATA.map(r => r.Tipo)).sort()];
    tipoSel.innerHTML = tipos.map(t => `<option value="${t}">${t}</option>`).join("");
    if(docList){
      const docs = uniq(DATA.map(r => r.N_Doc)).sort();
      docList.innerHTML = docs.map(d => `<option value="${d}"></option>`).join("");
    }
  }

  function applyFilters(){
    const q = (document.getElementById('q').value || "").trim().toLowerCase();
    const cat = document.getElementById('cat').value;
    const ue = document.getElementById('ue').value;
    const tipo = document.getElementById('tipo').value;
    const estado = document.getElementById('estado').value;
    
    // FILTROS 1: FECHA F8 (Documento)
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    // FILTROS 2: FECHA ASIGNACION (Proceso)
    const allocFrom = document.getElementById('allocDateFrom').value;
    const allocTo = document.getElementById('allocDateTo').value;

    let rows = DATA;
    const docQ = (document.getElementById('doc')?.value || '').trim().toLowerCase();
    
    if (docQ) rows = rows.filter(r => String(r.N_Doc || '').toLowerCase().includes(docQ));
    
    // APLICAR FILTRO FECHA F8
    if (dateFrom) rows = rows.filter(r => String(r.Fecha || '') >= dateFrom);
    if (dateTo) rows = rows.filter(r => String(r.Fecha || '') <= dateTo);

    // APLICAR FILTRO FECHA ASIGNACION (HIST√ìRICO)
    if (allocFrom || allocTo) {
        rows = rows.filter(r => {
            // Buscamos la fecha de proceso (Backend Hist√≥rico) o fallback a la fecha normal
            let fechaAlloc = r.Fecha_Proceso || r.Fecha_Asignacion || "";
            // Si es la vista diaria, puede que no tenga Fecha_Proceso a√∫n, usamos hoy impl√≠cito o nada
            // Pero si el usuario filtra por fecha de asignaci√≥n en "Diario", asumimos que busca la fecha de hoy.
            if (!fechaAlloc && r.Fecha_Asignacion) fechaAlloc = r.Fecha_Asignacion;

            if(!fechaAlloc) return true; // Si no hay fecha de proceso, lo dejamos pasar si estamos en vista simple
            
            const dStr = String(fechaAlloc).split("T")[0];
            let pass = true;
            if (allocFrom && dStr < allocFrom) pass = false;
            if (allocTo && dStr > allocTo) pass = false;
            return pass;
        });
    }

    if (q) rows = rows.filter(r => String(r.Codigo).includes(q) || String(r.Suministro || "").toLowerCase().includes(q));
    if (cat !== "ALL") rows = rows.filter(r => r.Categoria === cat);
    if (ue !== "ALL") rows = rows.filter(r => r.Punto === ue);
    if (tipo !== "ALL") rows = rows.filter(r => r.Tipo === tipo);
    if (estado !== "ALL") rows = rows.filter(r => coverage(r) === estado);
    
    LAST_FILTERED = rows;
    renderKPIs(rows);
    renderActiveTab(rows);
  }

  function renderKPIs(rows){
    const req = rows.reduce((a,r)=>a + Number(r.Solicitado||0), 0);
    const reqR = rows.reduce((a,r)=>a + Number(r.Solicitado_redondeado||0), 0);
    const asg = rows.reduce((a,r)=>a + Number(r.Asignado||0), 0);
    const fill = req > 0 ? (asg/req)*100 : 0;
    
    document.getElementById('k_lines').textContent = fmt(rows.length);
    document.getElementById('k_req').textContent = fmt(req);
    document.getElementById('k_req_r').textContent = fmt(reqR);
    document.getElementById('k_assigned').textContent = fmt(asg);
    document.getElementById('k_fill').textContent = `${fill.toFixed(1)}%`;
  }

  function showTab(tab){
    ACTIVE_TAB = tab;
    document.querySelectorAll('.tab').forEach(el => el.classList.toggle('active', el.dataset.tab === tab));
    document.querySelectorAll('.view').forEach(v => v.style.display = "none");
    document.getElementById(`view_${tab}`).style.display = "block";
    renderActiveTab(LAST_FILTERED.length ? LAST_FILTERED : DATA);
  }

  function renderAsignacion(rows){
    const tb = document.querySelector("#tbl_asignacion tbody");
    // L√çMITE AUMENTADO
    tb.innerHTML = rows.slice(0, 10000).map(r => {
      const b = fmtBultosTriple(r.Bultos_Ter||0, r.Bultos_Sec||0, r.Bultos_Prim||0);
      const lots = r.Lotes_Usados ? r.Lotes_Usados : "";
      
      const ldFecha = r.Ultimo_Despacho || "-";
      const ldQty = r.Qty_Ultimo ? fmt(r.Qty_Ultimo) : "-";
      const prom = r.Promedio_Hist ? fmt(r.Promedio_Hist) : "-";

      return `<tr>
        <td>${r.Fecha||""}</td>
        <td>${r.N_Doc||""}</td>
        <td>${r.Tipo||""}</td>
        <td>${r.Punto||""}</td>
        <td>${r.Categoria||""}</td>
        <td>${r.Codigo||""}</td>
        <td>${r.Suministro||""}</td>
        <td class="right">${fmt(r.Solicitado)}</td>
        <td class="right">${fmt(r.Solicitado_redondeado)}</td>
        <td class="right">${fmt(r.Asignado)}</td>
        <td class="right">${fmt(r.Pendiente)}</td>
        <td class="center">${b}</td>
        <td>${lots}</td>
        <td>${ldFecha}</td>
        <td class="right">${ldQty}</td>
        <td class="right" style="background:#f0f8ff;">${prom}</td>
      </tr>`;
    }).join("");
    window.__exportRows = rows;
    window.__exportName = "asignacion";
  }

  function renderUESin(rows){
    const filtered = rows.filter(r => Number(r.Asignado||0) === 0 && Number(r.Solicitado_redondeado||0) > 0);
    const map = new Map();
    for(const r of filtered){
      const key = `${r.Punto||""}||${r.Categoria||""}`;
      if(!map.has(key)) map.set(key, {UE:r.Punto||"", Categoria:r.Categoria||"", lineas:0, sol:0, solr:0, fechaMax:null});
      const o = map.get(key);
      o.lineas += 1;
      o.sol += Number(r.Solicitado||0);
      o.solr += Number(r.Solicitado_redondeado||0);
      const d = parseISODate(r.Fecha);
      if(d && (!o.fechaMax || d > o.fechaMax)) o.fechaMax = d;
    }
    const out = [...map.values()].map(o => ({
      UE:o.UE, Categoria:o.Categoria, Lineas_sin_cobertura:o.lineas,
      Solicitado_original:o.sol, Solicitado_redondeado:o.solr,
      Pedido_mas_reciente:o.fechaMax ? o.fechaMax.toISOString().slice(0,10) : ""
    })).sort((a,b)=> (b.Solicitado_redondeado - a.Solicitado_redondeado) || (b.Lineas_sin_cobertura - a.Lineas_sin_cobertura))
      .slice(0,20);
    const tb = document.querySelector("#tbl_ue_sin tbody");
    tb.innerHTML = out.map(r => `<tr>
      <td>${r.UE}</td>
      <td>${r.Categoria}</td>
      <td class="right">${fmt(r.Lineas_sin_cobertura)}</td>
      <td class="right">${fmt(r.Solicitado_original)}</td>
      <td class="right">${fmt(r.Solicitado_redondeado)}</td>
      <td>${r.Pedido_mas_reciente}</td>
    </tr>`).join("");
    window.__exportRows = out;
    window.__exportName = "ue_sin_cobertura_top20";
  }

  function renderSKUSin(rows){
    const filtered = rows.filter(r => Number(r.Asignado||0) === 0 && Number(r.Solicitado_redondeado||0) > 0);
    const map = new Map();
    for(const r of filtered){
      const code = String(r.Codigo||"");
      const key = `${code}||${String(r.Suministro||"")}`;
      if(!map.has(key)) map.set(key, {Codigo:code, Suministro:String(r.Suministro||""), sol:0, solr:0, ues:new Set(), cats:new Set(), last:null});
      const o = map.get(key);
      o.sol += Number(r.Solicitado||0);
      o.solr += Number(r.Solicitado_redondeado||0);
      o.ues.add(String(r.Punto||""));
      o.cats.add(String(r.Categoria||""));
      
      const fechaRow = r.Ultimo_Despacho;
      if(fechaRow && fechaRow !== "-"){
         const d = parseISODate(fechaRow);
         if(d && (!o.last || d > o.last)) o.last = d;
      }
    }
    const out = [...map.values()].map(o => ({
      Codigo:o.Codigo,
      Suministro:o.Suministro,
      Solicitado_original:o.sol,
      Solicitado_redondeado:o.solr,
      Num_UEs:o.ues.size,
      Categorias_afectadas:[...o.cats].filter(x=>x).sort().join(", "),
      Ultimo_despacho_real:o.last ? o.last.toISOString().slice(0,10) : ""
    })).sort((a,b)=> (b.Solicitado_redondeado - a.Solicitado_redondeado) || (b.Num_UEs - a.Num_UEs))
      .slice(0,20);
    const tb = document.querySelector("#tbl_sku_sin tbody");
    tb.innerHTML = out.map(r => `<tr>
      <td>${r.Codigo}</td>
      <td>${r.Suministro}</td>
      <td class="right">${fmt(r.Solicitado_original)}</td>
      <td class="right">${fmt(r.Solicitado_redondeado)}</td>
      <td class="right">${fmt(r.Num_UEs)}</td>
      <td>${r.Categorias_afectadas}</td>
      <td>${r.Ultimo_despacho_real || "-"}</td>
    </tr>`).join("");
    window.__exportRows = out;
    window.__exportName = "skus_criticos_sin_stock_top20";
  }

  function renderInvalidos(rows){
    const filtered = rows.filter(r => Number(r.Solicitado||0) > 0 && Number(r.Solicitado_redondeado||0) === 0);
    const out = filtered.slice().sort((a,b)=>{
      const da = parseISODate(a.Fecha); const db = parseISODate(b.Fecha);
      return (db - da);
    }).slice(0,2000).map(r => {
      const sol = Number(r.Solicitado||0);
      const empT = r.Empaque_Ter ? Number(r.Empaque_Ter) : null;
      
      let motivo = "Solicitado redondeado = 0";
      if(empT && sol < empT) motivo = "Solicitado menor a empaque terciario";
      else if(empT && (sol % empT) !== 0) motivo = "Solicitado no es m√∫ltiplo";
      else if(!empT) motivo = "Sin empaque definido";
      
      return {
        Fecha:r.Fecha||"", UE:r.Punto||"", Categoria:r.Categoria||"", Codigo:r.Codigo||"", Suministro:r.Suministro||"",
        Solicitado_original:sol, Empaque_terciario:empT, Solicitado_redondeado:Number(r.Solicitado_redondeado||0), Motivo:motivo
      };
    });
    const tb = document.querySelector("#tbl_invalidos tbody");
    tb.innerHTML = out.map(r => `<tr>
      <td>${r.Fecha}</td><td>${r.UE}</td><td>${r.Categoria}</td><td>${r.Codigo}</td><td>${r.Suministro}</td>
      <td class="right">${fmt(r.Solicitado_original)}</td>
      <td class="right">${r.Empaque_terciario === null ? "-" : fmt(r.Empaque_terciario)}</td>
      <td class="right">${fmt(r.Solicitado_redondeado)}</td>
      <td class="${r.Motivo.includes("menor") ? "danger" : ""}">${r.Motivo}</td>
    </tr>`).join("");
    window.__exportRows = out;
    window.__exportName = "pedidos_invalidos_por_empaque";
  }

  function renderFillCat(rows){
    const map = new Map();
    for(const r of rows){
      const cat = String(r.Categoria||"");
      if(!map.has(cat)) map.set(cat, {Categoria:cat, lineas:0, sol:0, solr:0, asg:0});
      const o = map.get(cat);
      o.lineas += 1;
      o.sol += Number(r.Solicitado||0);
      o.solr += Number(r.Solicitado_redondeado||0);
      o.asg += Number(r.Asignado||0);
    }
    const out = [...map.values()].map(o => ({
      Categoria:o.Categoria, Lineas:o.lineas, Solicitado_original:o.sol, Solicitado_redondeado:o.solr, Asignado:o.asg,
      Fill_rate: o.sol > 0 ? (o.asg/o.sol) : 0 
    })).sort((a,b)=> (a.Categoria||"").localeCompare(b.Categoria||""));
    const tb = document.querySelector("#tbl_fill_cat tbody");
    tb.innerHTML = out.map(r => `<tr>
      <td>${r.Categoria}</td>
      <td class="right">${fmt(r.Lineas)}</td>
      <td class="right">${fmt(r.Solicitado_original)}</td>
      <td class="right">${fmt(r.Solicitado_redondeado)}</td>
      <td class="right">${fmt(r.Asignado)}</td>
      <td class="right">${(r.Fill_rate*100).toFixed(1)}%</td>
    </tr>`).join("");
    window.__exportRows = out;
    window.__exportName = "fill_rate_por_categoria";
  }

  function renderActiveTab(rows){
    if(ACTIVE_TAB === "asignacion") return renderAsignacion(rows);
    if(ACTIVE_TAB === "ue_sin") return renderUESin(rows);
    if(ACTIVE_TAB === "sku_sin") return renderSKUSin(rows);
    if(ACTIVE_TAB === "invalidos") return renderInvalidos(rows);
    if(ACTIVE_TAB === "fill_cat") return renderFillCat(rows);
  }

  function exportCsv(){
    const rows = window.__exportRows || [];
    const cols = Object.keys(rows[0] || {});
    if (!cols.length) return;
    const esc = (v) => {
      const s = (v === null || v === undefined) ? "" : String(v);
      if (s.includes('"') || s.includes(",") || s.includes("\n")) return '"' + s.replaceAll('"','""') + '"';
      return s;
    };
    const csv = [cols.join(",")].concat(rows.map(r => cols.map(c => esc(r[c])).join(","))).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${window.__exportName || "export"}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function _pickingRows(){ 
    return LAST_FILTERED || []; 
  }

  function getDynamicFilename(prefix) {
    const ue = document.getElementById('ue').value;
    const cat = document.getElementById('cat').value;
    const tipo = document.getElementById('tipo').value;
    
    let parts = [prefix];
    if (ue && ue !== "ALL") parts.push(ue.replace(/[^a-zA-Z0-9\-_]/g, ""));
    if (cat && cat !== "ALL") parts.push(cat.replace(/[^a-zA-Z0-9\-_]/g, ""));
    if (tipo && tipo !== "ALL") parts.push(tipo.replace(/[^a-zA-Z0-9\-_]/g, ""));
    
    if (parts.length === 1) {
        const today = new Date();
        parts.push(`${today.getDate()}_${today.getMonth()+1}`);
    }
    
    let name = parts.join("_");
    if (name.length > 50) name = name.substring(0, 50); 
    return name;
  }

  // --- EXPORTACI√ìN PDF (SOLUCI√ìN FINAL "HARDCODED" PARA 1/16/2026) ---
  function exportPdfAsignacion(){
    const rows = _pickingRows();
    if(!rows.length){ alert("No hay datos visibles para exportar."); return; }
    
    const baseName = getDynamicFilename("Hoja_Asignacion");
    
    // 1. ENCONTRAR LA FECHA DE ASIGNACI√ìN M√ÅS RECIENTE (TEXTO)
    let fechaRaw = "";
    
    if (rows.length > 0) {
        // Buscamos fechas que tengan barras "/" (ej: 1/16/2026)
        const fechasConBarras = rows
            .map(r => r.Fecha_Asignacion || "")
            .filter(f => f.includes("/"));
            
        // Si hay fechas con barras, tomamos la √∫ltima
        if (fechasConBarras.length > 0) {
            fechasConBarras.sort();
            fechaRaw = fechasConBarras[fechasConBarras.length - 1];
        } 
        // Si no hay barras, buscamos con guiones (por si acaso viene del backend nuevo)
        else {
             const fechasGuiones = rows
                .map(r => r.Fecha_Asignacion || "")
                .filter(f => f.includes("-"))
                .sort();
             if (fechasGuiones.length > 0) fechaRaw = fechasGuiones[fechasGuiones.length - 1];
        }
    }

    // 2. RESTA MANUAL (MATEM√ÅTICA B√ÅSICA SOBRE TEXTO)
    let fechaCorteTexto = "";
    let sufijoCorte = " (Registro hist√≥rico)";

    if (fechaRaw) {
        let dia = 0, mes = 0, anio = 0;

        if (fechaRaw.includes("/")) {
            // FORMATO MANUAL TUYO: M/D/Y (ej: 1/16/2026)
            const partes = fechaRaw.split("/");
            // Asumimos M/D/Y porque as√≠ lo escribiste
            mes = parseInt(partes[0]); 
            dia = parseInt(partes[1]);
            anio = parseInt(partes[2]);
        } else {
            // FORMATO BACKEND ISO: Y-M-D (ej: 2026-01-16)
            const partes = fechaRaw.split("-");
            anio = parseInt(partes[0]);
            mes = parseInt(partes[1]);
            dia = parseInt(partes[2]);
        }

        // --- LA RESTA ---
        if (dia > 1) {
            dia = dia - 1; // 16 se vuelve 15
        } else {
            // Si es d√≠a 1, hay que retroceder mes
            mes = mes - 1;
            if (mes === 0) { mes = 12; anio = anio - 1; }
            // D√≠as aproximados para no complicar (reporte visual)
            const diasMes = [0,31,28,31,30,31,30,31,31,30,31,30,31]; 
            dia = diasMes[mes] || 30; 
        }

        // --- RECONSTRUCCI√ìN (MM/DD/YYYY) ---
        const dd = String(dia).padStart(2, '0');
        const mm = String(mes).padStart(2, '0');
        fechaCorteTexto = `${mm}/${dd}/${anio} 11:59 PM`;

    } else {
        // EMERGENCIA: Si no encuentra fecha, usa AYER real
        const hoy = new Date();
        hoy.setDate(hoy.getDate() - 1);
        let d = hoy.getDate();
        let m = hoy.getMonth() + 1;
        let y = hoy.getFullYear();
        fechaCorteTexto = `${String(m).padStart(2,'0')}/${String(d).padStart(2,'0')}/${y} 11:59 PM`;
        sufijoCorte = "";
    }

    const fechaGen = new Date().toLocaleString("en-US");

    const groups = new Map();
    for(const r of rows){
      const ue = r.Punto || "SIN_UE";
      const doc = r.N_Doc || "SIN_DOC";
      const key = ue + "||" + doc;
      const pr = Number.isFinite(+r.Prioridad) ? +r.Prioridad : 999;
      const f  = (r.Fecha||"");
      
      if(!groups.has(key)){ 
        groups.set(key, {
          ue, doc, tipo: r.Tipo||"", prioridad: pr, maxFecha: f, 
          items: [],
          totalSol: 0, totalRed: 0, totalAsig: 0, totalPend: 0
        }); 
      }
      const g = groups.get(key);
      g.items.push(r);
      
      g.totalSol += Number(r.Solicitado||0);
      g.totalRed += Number(r.Solicitado_redondeado||0);
      g.totalAsig += Number(r.Asignado||0);
      g.totalPend += Number(r.Pendiente||0);

      if(String(f) > String(g.maxFecha)) g.maxFecha = f;
      if(pr < g.prioridad) g.prioridad = pr;
    }
    
    const groupsArr = Array.from(groups.values()).sort((a,b)=>{
      if(a.prioridad !== b.prioridad) return a.prioridad - b.prioridad;
      if(a.maxFecha !== b.maxFecha) return String(b.maxFecha).localeCompare(String(a.maxFecha));
      return String(a.doc).localeCompare(String(b.doc));
    });

    const esc = (s) => (s===null||s===undefined) ? "" : String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    const fmt0 = (n) => { const x = Number(n); if(!Number.isFinite(x)) return ""; return x.toLocaleString("en-US", {maximumFractionDigits: 0}); };

    const makeRow = (r) => {
      const b = fmtBultosTriple(r.Bultos_Ter||0, r.Bultos_Sec||0, r.Bultos_Prim||0);
      const lotes = r.Lotes_Usados ? String(r.Lotes_Usados) : "";
      const ldFecha = r.Ultimo_Despacho || "-";
      const ldQty = r.Qty_Ultimo ? fmt0(r.Qty_Ultimo) : "";
      const prom = r.Promedio_Hist ? fmt0(r.Promedio_Hist) : "";

      return `
      <tr>
        <td>${esc(r.Codigo)}</td>
        <td>${esc(r.Suministro||"")}</td>
        <td class="num">${fmt0(r.Solicitado)}</td>
        <td class="num">${fmt0(r.Solicitado_redondeado)}</td>
        <td class="num" style="background:#e3f2fd; font-weight:bold;">${fmt0(r.Asignado)}</td>
        <td class="num">${fmt0(r.Pendiente)}</td>
        <td class="center">${esc(b)}</td>
        <td style="font-size:9px;">${esc(lotes)}</td>
        <td>${esc(ldFecha)}</td>
        <td class="num">${ldQty}</td>
        <td class="num">${prom}</td>
      </tr>`;
    };

    const sections = groupsArr.map((g, idx) => {
      g.items.sort((a,b)=> String(a.Codigo||"").localeCompare(String(b.Codigo||"")));
      const rowsHtml = g.items.map(makeRow).join("");
      const totalItems = g.items.length;
      
      const escasezDetectada = g.totalRed > g.totalAsig;
      const fillRate = g.totalSol > 0 ? ((g.totalAsig / g.totalSol) * 100).toFixed(1) + "%" : "0%";
      let escasezLabel = escasezDetectada ? "‚ö†Ô∏è S√ç (Fair Share aplicado)" : "‚úÖ NO (Stock suficiente)";
      let escasezClass = escasezDetectada ? "color:#b00020;" : "color:#0a7a2f;";

      if (g.items.some(i => i.Pack_Missing)) {
         escasezLabel += ` <span style="color:#b00020; font-size:10px; margin-left:8px;">(Nota: No existe empaque definido, se asume unidad m√≠nima 1)</span>`;
      }

      return `
        <div class="section">
          <table>
            <thead>
              <tr>
                <td colspan="11" style="background:#fff; border-bottom:2px solid #0b1f3a; padding: 10px 0;">
                  <div style="display:flex; gap:15px; align-items:center;">
                    <img src="./icons/icon-512.png" style="width:50px; height:50px; object-fit:contain;" alt="logo"/>
                    <div style="flex:1;">
                      <div style="font-size:18px; font-weight:700; color:#0b1f3a;">HOJA DE ASIGNACI√ìN F8 ‚Äî CORTE DIARIO</div>
                      <div style="font-size:11px; color:#444; margin-top:4px;">Generado: ${esc(fechaGen)} | Corte: ${esc(fechaCorteTexto)}${esc(sufijoCorte)}</div>
                      <div style="font-size:10px; color:#666; margin-top:2px; font-style:italic;">
                         Reglas de Asignaci√≥n: <b>Fair Share (Reparto Proporcional en Escasez)</b>, FEFO, Vto ‚â• 30 d√≠as.
                         <br>Prioridad por Tipo de Unidad Ejecutora: <b>CEDIS > HOSPITAL > POLICLINICA > ULAPS > CAPPS</b>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              <tr class="meta-row">
                <th colspan="11" style="background:#f4f6f8; color:#0b1f3a; padding:10px; border-bottom:2px solid #0b1f3a; border-top:none;">
                  <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:14px; font-weight:900;">${esc(g.ue)}</div>
                    <div style="font-size:11px;">L√≠neas: <b>${totalItems}</b></div>
                  </div>
                  <div style="margin-top:4px; font-size:11px; display:flex; gap:15px; color:#444;">
                    <span>Doc: <b>${esc(g.doc)}</b></span>
                    <span>Tipo: <b>${esc(g.tipo)}</b></span>
                    <span>Fecha F8: <b>${esc(g.maxFecha||"")}</b></span>
                  </div>
                  <div style="margin-top:6px; padding-top:6px; border-top:1px solid #ccc; font-size:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-weight:bold; ${escasezClass}">Escasez: ${escasezLabel}</div>
                    <div style="display:flex; gap:12px; background:#fff; padding:3px 8px; border-radius:4px; border:1px solid #ddd;">
                       <span>Solic.: <b>${fmt0(g.totalSol)}</b></span>
                       <span>Red.: <b>${fmt0(g.totalRed)}</b></span>
                       <span style="color:#0052cc;">Asig.: <b>${fmt0(g.totalAsig)}</b></span>
                       <span>Pend.: <b>${fmt0(g.totalPend)}</b></span>
                       <span>Fill Rate: <b>${fillRate}</b></span>
                    </div>
                  </div>
                </th>
              </tr>
              <tr class="col-header">
                <th style="width:70px;">C√≥digo</th>
                <th>Suministro</th>
                <th style="width:50px;" class="num">Solic.</th>
                <th style="width:50px;" class="num">Sol.red</th>
                <th style="width:50px;" class="num">Asig.</th>
                <th style="width:50px;" class="num">Pend.</th>
                <th style="width:65px;" class="center">Bultos</th>
                <th style="width:130px;">Lotes</th>
                <th style="width:65px;">√ölt.desp</th>
                <th style="width:40px;" class="num">Qty</th>
                <th style="width:40px;" class="num">Prom</th>
              </tr>
            </thead>
            <tbody>${rowsHtml}</tbody>
          </table>
          
          <div class="sign">
             <div>Preparado por: __________________</div>
             <div>Recibido por: __________________</div>
             <div>Fecha: __________________</div>
          </div>
          <div style="text-align:center; font-size:9px; color:#999; margin-top:5px; border-top:1px dashed #ccc; padding-top:2px;">
             Fin del Documento ${esc(g.doc)}
          </div>
        </div>`;
    }).join("");

    const w = window.open("", "_blank"); w.document.open(); w.document.write(html); w.document.close(); w.focus(); 
    setTimeout(()=>{ w.print(); }, 500);
  }

  function exportXlsxAsignacion(){
    const rows = _pickingRows(); 
    if(!rows.length){ alert("No hay datos visibles para exportar."); return; }
    if(typeof XLSX === "undefined"){ alert("No se pudo cargar XLSX."); return; }
    
    const fileName = getDynamicFilename("Asignacion_F8") + ".xlsx";

    const groups = new Map();
    for(const r of rows){
      const ue = r.Punto || "SIN_UE"; const doc = r.N_Doc || "SIN_DOC"; const key = ue + "||" + doc;
      if(!groups.has(key)) groups.set(key, {ue, doc, tipo: r.Tipo||"", items: []});
      groups.get(key).items.push(r);
    }
    const corte = (PARAMS && PARAMS.corte) ? PARAMS.corte : "";
    const now = new Date().toLocaleString("es-PA");
    const aoa = [];
    aoa.push(["HOJA DE ASIGNACI√ìN F8 ‚Äî CORTE DIARIO"]);
    aoa.push([`Generado: ${now}`, `Corte: ${corte}`, "Reglas: Fair Share | Prioridad: Mensual > Fecha > UE"]);
    aoa.push([]);
    const header = ["UE", "Documento", "Tipo", "C√≥digo", "Suministro", "Solicitado", "Solic. red.", "Asignado", "Pendiente", "Bultos T/S/P", "Lotes usados", "√öltimo despacho (real)", "Qty √∫ltimo", "Promedio Hist."];
    aoa.push(header);
    for(const g of Array.from(groups.values()).sort((a,b)=> (a.ue+a.doc).localeCompare(b.ue+b.doc))){
      g.items.sort((a,b)=> String(a.Codigo||"").localeCompare(String(b.Codigo||"")));
      for(const r of g.items){
        const bults = `${fmtBultosPart(r.Bultos_Ter||0)}/${fmtBultosPart(r.Bultos_Sec||0)}/${fmtBultosPart(r.Bultos_Prim||0)}`;
        const ldFecha = r.Ultimo_Despacho || "";
        const ldQty = r.Qty_Ultimo ? Number(r.Qty_Ultimo) : "";
        const prom = r.Promedio_Hist ? Number(r.Promedio_Hist) : "";

        aoa.push([
          g.ue, g.doc, g.tipo, r.Codigo||"", r.Suministro||"", Number(r.Solicitado||0), Number(r.Solicitado_redondeado||0),
          Number(r.Asignado||0), Number(r.Pendiente||0), bults, r.Lotes_Usados||"", 
          ldFecha, ldQty, prom
        ]);
      }
      aoa.push([]);
    }
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    ws["!cols"] = [{wch:22},{wch:18},{wch:12},{wch:12},{wch:60},{wch:12},{wch:12},{wch:12},{wch:12},{wch:14},{wch:40},{wch:18},{wch:12},{wch:12}];
    ws["!freeze"] = { xSplit: 0, ySplit: 4 };
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Asignacion_F8");
    XLSX.writeFile(wb, fileName);
  }

  // --- L√ìGICA DE CARGA DE DATOS ---
  const WEBAPP_BASE = "https://script.google.com/macros/s/AKfycbyVHDQ8IuVHibz259AiEvZ-jUfVC7fxvSSqC-wfaiiq1_13C9_TK4dVtPK0SMW4sZoJ/exec";

  function loadJsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      const script = document.createElement('script');
      script.src = `${url}&callback=${cb}&_ts=${Date.now()}`;
      script.onerror = () => reject(new Error('Script error'));
      window[cb] = (data) => { resolve(data); delete window[cb]; script.remove(); };
      document.body.appendChild(script);
    });
  }

  async function fetchAndLoad(type) {
    const isHistory = type === 'history';
    const btn = isHistory ? document.getElementById('btnLoadHistory') : document.getElementById('btnLoadDaily');
    const originalText = btn.textContent;
    btn.textContent = "Cargando...";
    document.body.style.cursor = 'wait';

    try {
      let newData;
      if (type === 'allocation') {
          const [alloc, params] = await Promise.all([
              loadJsonp(`${WEBAPP_BASE}?file=allocation`),
              loadJsonp(`${WEBAPP_BASE}?file=params`)
          ]);
          newData = alloc;
          PARAMS = params; 
          document.getElementById('mainHeader').textContent = "Asignaci√≥n F8 (Corte diario)";
          document.getElementById('cutDate').textContent = PARAMS.cut_date || "Hoy";
      } else {
          newData = await loadJsonp(`${WEBAPP_BASE}?file=history`);
          document.getElementById('mainHeader').textContent = "HISTORIAL ACUMULADO";
          document.getElementById('cutDate').textContent = "Hist√≥rico Completo";
      }

      if (!newData || newData.length === 0) alert("No se encontraron datos.");
      else {
          DATA = newData;
          populateFilters(); applyFilters();    
      }
    } catch (e) { console.error(e); alert("Error de conexi√≥n."); } 
    finally { btn.textContent = originalText; document.body.style.cursor = 'default'; }
  }

  async function init(){
    tickDateTime(); setInterval(tickDateTime, 60000);
    fetchAndLoad('allocation');
    
    document.getElementById('btnLoadDaily').addEventListener('click', () => fetchAndLoad('allocation'));
    document.getElementById('btnLoadHistory').addEventListener('click', () => fetchAndLoad('history'));
    
    document.getElementById('btnApply').addEventListener('click', applyFilters);
    document.getElementById('btnReset').addEventListener('click', () => {
        document.getElementById('q').value = ""; document.getElementById('doc').value = ""; document.getElementById('dateFrom').value = ""; document.getElementById('dateTo').value = ""; document.getElementById('cat').value = "ALL"; document.getElementById('ue').value = "ALL"; document.getElementById('tipo').value = "ALL"; document.getElementById('estado').value = "ALL";
        document.getElementById('allocDateFrom').value = ""; document.getElementById('allocDateTo').value = "";
        applyFilters();
    });
    
    document.getElementById('btnExportCsv').addEventListener('click', exportCsv);
    document.getElementById('btnExportPdf').addEventListener('click', exportPdfAsignacion);
    document.getElementById('btnExportXlsx').addEventListener('click', exportXlsxAsignacion);
    
    document.querySelectorAll('.tab').forEach(el => el.addEventListener('click', () => showTab(el.dataset.tab)));
  }
  
  const btnLoad = document.getElementById('btnLoadLocal');
  const fileLoad = document.getElementById('fileLoad');
  if (btnLoad && fileLoad){
    btnLoad.addEventListener('click', ()=> fileLoad.click());
    fileLoad.addEventListener('change', async (ev)=>{
      const files = Array.from(ev.target.files || []);
      if (!files.length) return;
      const byName = Object.fromEntries(files.map(f=>[f.name.toLowerCase(), f]));
      async function readJson(file){ const txt = await file.text(); return JSON.parse(txt); }
      try{
        if (byName['allocation.json']) DATA = await readJson(byName['allocation.json']);
        if (byName['params.json']) PARAMS = await readJson(byName['params.json']);
        populateFilters(); applyFilters(); alert('Datos locales cargados.');
      }catch(e){ console.error(e); alert('No se pudo cargar uno de los JSON.'); }finally{ fileLoad.value = ''; }
    });
  }
  init();
</script>
</body>
</html>
